{% extends "base.html" %}

{% block title %}{{ day.name }}{% endblock %}

{% block body %}
<div class="min-h-full flex flex-col bg-dark-900">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-dark-800/95 backdrop-blur border-b border-dark-600 px-4 py-3 safe-area-inset">
        <div class="max-w-lg mx-auto flex items-center justify-between">
            <a href="{{ url_for('plan') }}" class="flex items-center gap-2 text-gray-400 hover:text-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                <span class="text-sm">Back</span>
            </a>
            
            <div class="text-center">
                <h1 class="text-base font-semibold text-gray-100">{{ day.name }}</h1>
                <p class="text-xs text-gray-500">Week {{ day_number }}{% if cycle %} Â· {{ cycle.name }}{% endif %}</p>
            </div>
            
            <button onclick="resetWorkout()" class="text-sm text-gray-500 hover:text-warning transition-colors">
                Reset
            </button>
        </div>
    </header>
    
    <!-- Progress Bar -->
    <div class="bg-dark-800 px-4 py-2 border-b border-dark-700">
        <div class="max-w-lg mx-auto">
            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                <span id="progress-text">0 / {{ day.exercises | sum(attribute='sets') }} sets</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="h-1.5 bg-dark-600 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-accent rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Exercise List -->
    <main class="flex-1 px-4 py-4 pb-24">
        <div class="max-w-lg mx-auto space-y-4">
            {% for exercise in day.exercises %}
            <div class="exercise-card bg-dark-800 border border-dark-600 rounded-xl overflow-hidden transition-workout"
                data-exercise-index="{{ loop.index0 }}"
                data-exercise-id="{{ exercise.id }}"
                data-total-sets="{{ exercise.sets }}">
                 
                <!-- Exercise Header -->
                <button onclick="toggleExercise({{ loop.index0 }})" 
                        class="w-full px-4 py-4 flex items-center justify-between text-left">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <span class="exercise-number flex items-center justify-center w-7 h-7 rounded-lg bg-dark-600 text-gray-400 font-mono text-sm">
                                {{ loop.index }}
                            </span>
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="font-medium text-gray-100">{{ exercise.name }}</h3>
                                    <button onclick="event.stopPropagation(); ExerciseNotes.openModal('{{ exercise.id }}', '{{ exercise.name }}')"
                                            class="note-icon-btn p-1 rounded hover:bg-dark-600 transition-colors"
                                            data-exercise-id="{{ exercise.id }}"
                                            title="Personal notes">
                                        <!-- Empty note icon (gray) -->
                                        <svg class="note-icon-empty w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        <!-- Has note icon (green) - hidden by default -->
                                        <svg class="note-icon-filled w-4 h-4 text-success hidden" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500">
                                    {{ exercise.sets }} Ã— {{ exercise.rep_range }}
                                    {% if exercise.rest_seconds %}
                                    Â· <span class="text-gray-600">{{ exercise.rest_seconds // 60 }}:{{ '%02d' | format(exercise.rest_seconds % 60) }} rest</span>
                                    {% endif %}
                                    {% if exercise.is_heavy %}
                                    <span class="ml-1 text-accent">(Heavy)</span>
                                    {% else %}
                                    <span class="ml-1 text-gray-600">(Light)</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Completion indicator -->
                    <div class="flex items-center gap-2">
                        <span class="exercise-sets-done text-sm text-gray-600">0/{{ exercise.sets }}</span>
                        <svg class="exercise-chevron w-5 h-5 text-gray-600 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                </button>
                
                <!-- Expanded Content -->
                <div class="exercise-content hidden">
                    <!-- Form Cues & Video Section -->
                    <div class="px-4 pb-3">
                        <button onclick="toggleCues({{ loop.index0 }})" 
                                class="flex items-center gap-2 text-sm text-accent-dim hover:text-accent transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Form cues</span>
                        </button>
                        
                        <div class="cues-content hidden mt-2 p-3 bg-dark-700 rounded-lg cue-animate">
                            {% if exercise.cues and exercise.cues|length > 0 %}
                            <ul class="space-y-1.5 mb-3">
                                {% for cue in exercise.cues %}
                                <li class="flex items-start gap-2 text-sm text-gray-400">
                                    <span class="text-accent mt-0.5">â€¢</span>
                                    {{ cue }}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            
                            <!-- Video Demo Section -->
                            <div class="video-section border-t border-dark-600 pt-3 mt-3" 
                                 data-exercise-id="{{ exercise.id }}"
                                 data-exercise-name="{{ exercise.name }}"
                                 data-video-url="{{ exercise.video_url or '' }}"
                                 data-excluded-videos="">
                                
                                {% if exercise.video_url %}
                                <!-- Has saved video -->
                                <div class="video-saved flex items-center gap-3">
                                    <button onclick="openVideoModal('{{ exercise.video_url }}', '{{ exercise.name }}')"
                                            class="relative flex-shrink-0 w-24 h-16 rounded-lg overflow-hidden bg-dark-600 hover:ring-2 hover:ring-accent transition-all">
                                        <img src="https://img.youtube.com/vi/{{ exercise.video_url.split('v=')[-1].split('&')[0] if 'v=' in exercise.video_url else exercise.video_url.split('/')[-1] }}/mqdefault.jpg" 
                                             alt="Video thumbnail" class="w-full h-full object-cover">
                                        <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                        </div>
                                    </button>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-gray-400 truncate">Demo video</p>
                                        <button onclick="searchNewVideo({{ loop.index0 }})" 
                                                class="text-xs text-gray-500 hover:text-accent transition-colors">
                                            Find different video
                                        </button>
                                    </div>
                                </div>
                                {% else %}
                                <!-- No video yet - show search button or loading state -->
                                <div class="video-empty">
                                    <button onclick="searchVideo({{ loop.index0 }})"
                                            class="video-search-btn flex items-center gap-2 text-xs text-gray-500 hover:text-accent transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span>Find demo video</span>
                                    </button>
                                </div>
                                <!-- Video suggestion (populated by JS) -->
                                <div class="video-suggestion hidden mt-3"></div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sets -->
                    <div class="px-4 pb-4 space-y-2">
                        {% set exercise_idx = loop.index0 %}
                        {% for set_num in range(1, exercise.sets + 1) %}
                        <div class="set-row flex items-center gap-3 p-3 bg-dark-700 rounded-lg border border-transparent transition-workout"
                             data-set-index="{{ set_num - 1 }}">
                            
                            <span class="set-number w-6 text-center text-sm font-mono text-gray-500">{{ set_num }}</span>
                            
                            <div class="flex-1 flex items-center gap-2">
                                <!-- Weight Input -->
                                <div class="flex-1">
                                    <label class="sr-only">Weight</label>
                                    <div class="relative">
                                        <input type="number" 
                                               class="weight-input w-full bg-dark-600 border border-dark-500 rounded-lg px-3 py-2.5 text-center text-gray-100 font-mono text-lg focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent"
                                               placeholder="0"
                                               inputmode="decimal"
                                               data-exercise="{{ exercise_idx }}"
                                               data-set="{{ set_num - 1 }}">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-600">lbs</span>
                                    </div>
                                </div>
                                
                                <!-- Reps Input -->
                                <div class="flex-1">
                                    <label class="sr-only">Reps</label>
                                    <div class="relative">
                                        <input type="number" 
                                               class="reps-input w-full bg-dark-600 border border-dark-500 rounded-lg px-3 py-2.5 text-center text-gray-100 font-mono text-lg focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent"
                                               placeholder="{{ exercise.rep_range.split('-')[0] }}"
                                               inputmode="numeric"
                                               data-exercise="{{ exercise_idx }}"
                                               data-set="{{ set_num - 1 }}">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-600">reps</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Complete Set Button -->
                            <button class="complete-set-btn flex items-center justify-center w-11 h-11 rounded-lg bg-dark-600 border border-dark-500 text-gray-500 hover:bg-accent hover:border-accent hover:text-dark-900 transition-all active:scale-95"
                                    onclick="completeSet({{ exercise_idx }}, {{ set_num - 1 }})">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>
    
    <!-- Floating Action Button - Finish Workout -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-dark-900 via-dark-900/95 to-transparent pointer-events-none">
        <div class="max-w-lg mx-auto pointer-events-auto">
            <button id="finish-workout-btn" 
                    onclick="finishWorkout()"
                    class="w-full py-4 px-6 bg-dark-700 border border-dark-600 rounded-xl text-gray-500 font-medium transition-all disabled:opacity-50"
                    disabled>
                Complete Workout
            </button>
        </div>
    </div>
</div>

<!-- Exercise Notes Modal -->
<div id="notes-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80" onclick="ExerciseNotes.closeModal()"></div>
    <div class="absolute inset-4 flex items-center justify-center">
        <div class="bg-dark-800 rounded-2xl overflow-hidden w-full max-w-md">
            <div class="flex items-center justify-between p-4 border-b border-dark-600">
                <h3 id="notes-modal-title" class="font-medium text-gray-100">Personal Notes</h3>
                <button onclick="ExerciseNotes.closeModal()" class="text-gray-500 hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4">
                <textarea id="notes-textarea" 
                          class="w-full h-32 bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-gray-100 text-sm focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent resize-none"
                          placeholder="Add personal notes (e.g., seat height, grip width, machine settings...)"
                          maxlength="500"></textarea>
                <div class="flex items-center justify-between mt-2">
                    <span id="notes-char-count" class="text-xs text-gray-600">0/500</span>
                    <button onclick="ExerciseNotes.deleteNote()" 
                            class="text-xs text-red-400 hover:text-red-300 transition-colors">
                        Clear note
                    </button>
                </div>
            </div>
            <div class="flex gap-3 p-4 border-t border-dark-600">
                <button onclick="ExerciseNotes.closeModal()" 
                        class="flex-1 py-2.5 px-4 bg-dark-700 border border-dark-600 rounded-lg text-gray-400 hover:text-gray-200 transition-colors">
                    Cancel
                </button>
                <button onclick="ExerciseNotes.saveNote()" 
                        class="flex-1 py-2.5 px-4 bg-accent text-dark-900 rounded-lg font-medium hover:bg-accent/90 transition-colors">
                    Save Note
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Video Modal -->
<div id="video-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80" onclick="closeVideoModal()"></div>
    <div class="absolute inset-4 flex items-center justify-center">
        <div class="bg-dark-800 rounded-2xl overflow-hidden w-full max-w-lg">
            <div class="flex items-center justify-between p-4 border-b border-dark-600">
                <h3 id="video-modal-title" class="font-medium text-gray-100 truncate pr-4">Exercise Demo</h3>
                <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="aspect-video bg-black">
                <iframe id="video-iframe" class="w-full h-full" src="" frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/exercise-notes.js') }}"></script>
<script>
    // Workout state
    const STORAGE_KEY = 'workout_cycle_{{ scheduled_workout.id }}';
    const TOTAL_SETS = {{ day.exercises | sum(attribute='sets') }};
    const SCHEDULED_ID = '{{ scheduled_workout.id }}';
    const SLOT_ID = '{{ day.id }}';
    const WORKOUT_NAME = '{{ day.name }}';
    
    let workoutState = {
        scheduledId: SCHEDULED_ID,
        slotId: SLOT_ID,
        workoutName: WORKOUT_NAME,
        startedAt: null,
        exercises: [
            {% for exercise in day.exercises %}
            {
                id: "{{ exercise.id }}",
                name: "{{ exercise.name }}",
                targetSets: {{ exercise.sets }},
                sets: Array({{ exercise.sets }}).fill(null).map(() => ({ weight: null, reps: null, completed: false }))
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        expandedExercise: 0
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        renderState();
        expandExercise(workoutState.expandedExercise);
        
        // Load exercise notes
        const exerciseIds = workoutState.exercises.map(e => e.id);
        ExerciseNotes.loadNotesForWorkout(exerciseIds);
    });
    
    // State Management
    function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // Merge saved data into state
                workoutState = { ...workoutState, ...parsed };
                
                // Restore input values
                workoutState.exercises.forEach((exercise, exIdx) => {
                    exercise.sets.forEach((set, setIdx) => {
                        const weightInput = document.querySelector(`.weight-input[data-exercise="${exIdx}"][data-set="${setIdx}"]`);
                        const repsInput = document.querySelector(`.reps-input[data-exercise="${exIdx}"][data-set="${setIdx}"]`);
                        
                        if (weightInput && set.weight !== null) weightInput.value = set.weight;
                        if (repsInput && set.reps !== null) repsInput.value = set.reps;
                    });
                });
            } catch (e) {
                console.error('Failed to load state:', e);
            }
        }
    }
    
    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(workoutState));
    }
    
    function renderState() {
        let completedSets = 0;
        
        workoutState.exercises.forEach((exercise, exIdx) => {
            const card = document.querySelector(`[data-exercise-index="${exIdx}"]`);
            const setsDoneEl = card.querySelector('.exercise-sets-done');
            const numberEl = card.querySelector('.exercise-number');
            
            let exerciseCompletedSets = exercise.sets.filter(s => s.completed).length;
            completedSets += exerciseCompletedSets;
            
            setsDoneEl.textContent = `${exerciseCompletedSets}/${exercise.targetSets}`;
            
            // Update exercise card styling
            if (exerciseCompletedSets === exercise.targetSets) {
                numberEl.classList.remove('bg-dark-600', 'text-gray-400');
                numberEl.classList.add('bg-success/20', 'text-success');
                setsDoneEl.classList.add('text-success');
            } else {
                numberEl.classList.add('bg-dark-600', 'text-gray-400');
                numberEl.classList.remove('bg-success/20', 'text-success');
                setsDoneEl.classList.remove('text-success');
            }
            
            // Update set row styling
            exercise.sets.forEach((set, setIdx) => {
                const setRow = card.querySelectorAll('.set-row')[setIdx];
                const btn = setRow.querySelector('.complete-set-btn');
                
                if (set.completed) {
                    setRow.classList.add('set-completed');
                    btn.classList.add('bg-success', 'border-success', 'text-white');
                    btn.classList.remove('bg-dark-600', 'border-dark-500', 'text-gray-500', 'hover:bg-accent', 'hover:border-accent', 'hover:text-dark-900');
                } else {
                    setRow.classList.remove('set-completed');
                    btn.classList.remove('bg-success', 'border-success', 'text-white');
                    btn.classList.add('bg-dark-600', 'border-dark-500', 'text-gray-500', 'hover:bg-accent', 'hover:border-accent', 'hover:text-dark-900');
                }
            });
        });
        
        // Update progress
        const percent = Math.round((completedSets / TOTAL_SETS) * 100);
        document.getElementById('progress-bar').style.width = `${percent}%`;
        document.getElementById('progress-text').textContent = `${completedSets} / ${TOTAL_SETS} sets`;
        document.getElementById('progress-percent').textContent = `${percent}%`;
        
        // Update finish button
        const finishBtn = document.getElementById('finish-workout-btn');
        if (completedSets > 0) {
            finishBtn.disabled = false;
            finishBtn.classList.remove('bg-dark-700', 'border-dark-600', 'text-gray-500');
            finishBtn.classList.add('bg-success', 'border-success', 'text-white', 'hover:bg-success/90');
        } else {
            finishBtn.disabled = true;
            finishBtn.classList.add('bg-dark-700', 'border-dark-600', 'text-gray-500');
            finishBtn.classList.remove('bg-success', 'border-success', 'text-white', 'hover:bg-success/90');
        }
    }
    
    // Exercise toggle
    function toggleExercise(index) {
        if (workoutState.expandedExercise === index) {
            collapseExercise(index);
            workoutState.expandedExercise = -1;
        } else {
            if (workoutState.expandedExercise >= 0) {
                collapseExercise(workoutState.expandedExercise);
            }
            expandExercise(index);
            workoutState.expandedExercise = index;
        }
        saveState();
    }
    
    function expandExercise(index) {
        const card = document.querySelector(`[data-exercise-index="${index}"]`);
        if (!card) return;
        
        const content = card.querySelector('.exercise-content');
        const chevron = card.querySelector('.exercise-chevron');
        
        content.classList.remove('hidden');
        chevron.classList.add('rotate-180');
        card.classList.add('exercise-active');
        
        // Scroll into view
        setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }
    
    function collapseExercise(index) {
        const card = document.querySelector(`[data-exercise-index="${index}"]`);
        if (!card) return;
        
        const content = card.querySelector('.exercise-content');
        const chevron = card.querySelector('.exercise-chevron');
        
        content.classList.add('hidden');
        chevron.classList.remove('rotate-180');
        card.classList.remove('exercise-active');
    }
    
    // Cues toggle
    function toggleCues(index) {
        const card = document.querySelector(`[data-exercise-index="${index}"]`);
        const cuesContent = card.querySelector('.cues-content');
        if (cuesContent) {
            cuesContent.classList.toggle('hidden');
        }
    }
    
    // Set completion
    function completeSet(exerciseIndex, setIndex) {
        const exercise = workoutState.exercises[exerciseIndex];
        const set = exercise.sets[setIndex];
        
        // Get input values
        const weightInput = document.querySelector(`.weight-input[data-exercise="${exerciseIndex}"][data-set="${setIndex}"]`);
        const repsInput = document.querySelector(`.reps-input[data-exercise="${exerciseIndex}"][data-set="${setIndex}"]`);
        
        set.weight = weightInput.value ? parseFloat(weightInput.value) : null;
        set.reps = repsInput.value ? parseInt(repsInput.value) : null;
        set.completed = !set.completed;
        
        if (!workoutState.startedAt) {
            workoutState.startedAt = new Date().toISOString();
        }
        
        saveState();
        renderState();
        
        // Auto-advance to next set or exercise
        if (set.completed) {
            // Copy weight to next set if empty
            const nextSetIndex = setIndex + 1;
            if (nextSetIndex < exercise.sets.length) {
                const nextWeightInput = document.querySelector(`.weight-input[data-exercise="${exerciseIndex}"][data-set="${nextSetIndex}"]`);
                if (nextWeightInput && !nextWeightInput.value && set.weight) {
                    nextWeightInput.value = set.weight;
                    exercise.sets[nextSetIndex].weight = set.weight;
                    saveState();
                }
                nextWeightInput?.focus();
            } else {
                // Move to next exercise if all sets done
                const nextExerciseIndex = exerciseIndex + 1;
                if (nextExerciseIndex < workoutState.exercises.length) {
                    toggleExercise(nextExerciseIndex);
                }
            }
        }
    }
    
    // Save input on change
    document.querySelectorAll('.weight-input, .reps-input').forEach(input => {
        input.addEventListener('change', (e) => {
            const exerciseIndex = parseInt(e.target.dataset.exercise);
            const setIndex = parseInt(e.target.dataset.set);
            const value = e.target.value ? parseFloat(e.target.value) : null;
            
            if (e.target.classList.contains('weight-input')) {
                workoutState.exercises[exerciseIndex].sets[setIndex].weight = value;
            } else {
                workoutState.exercises[exerciseIndex].sets[setIndex].reps = value;
            }
            
            saveState();
        });
    });
    
    // Reset workout
    function resetWorkout() {
        if (confirm('Reset all progress for this workout?')) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }
    
    // Finish workout
    async function finishWorkout() {
        const completedSets = workoutState.exercises.reduce((sum, ex) => 
            sum + ex.sets.filter(s => s.completed).length, 0);
        
        if (!confirm(`Complete workout with ${completedSets}/${TOTAL_SETS} sets done?`)) {
            return;
        }
        
        const finishBtn = document.getElementById('finish-workout-btn');
        finishBtn.disabled = true;
        finishBtn.textContent = 'Saving...';
        
        try {
            const response = await fetch('/api/workout/save-cycle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scheduled_id: SCHEDULED_ID,
                    slot_id: SLOT_ID,
                    workout_name: WORKOUT_NAME,
                    exercises: workoutState.exercises
                })
            });
            
            if (response.ok) {
                // Clear local storage
                localStorage.removeItem(STORAGE_KEY);
                alert('Workout saved! ðŸ’ª');
                window.location.href = '/plan';
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Failed to save');
            }
        } catch (err) {
            console.error('Save error:', err);
            alert('Error saving workout: ' + err.message);
            finishBtn.disabled = false;
            finishBtn.textContent = 'Complete Workout';
        }
    }
    
    // ============================================
    // VIDEO FUNCTIONS
    // ============================================
    
    function openVideoModal(videoUrl, title) {
        const modal = document.getElementById('video-modal');
        const iframe = document.getElementById('video-iframe');
        const modalTitle = document.getElementById('video-modal-title');
        
        // Extract video ID and create embed URL
        let videoId = '';
        if (videoUrl.includes('v=')) {
            videoId = videoUrl.split('v=')[1].split('&')[0];
        } else if (videoUrl.includes('youtu.be/')) {
            videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
        } else if (videoUrl.includes('/embed/')) {
            videoId = videoUrl.split('/embed/')[1].split('?')[0];
        } else {
            videoId = videoUrl.split('/').pop();
        }
        
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        modalTitle.textContent = title || 'Exercise Demo';
        modal.classList.remove('hidden');
    }
    
    function closeVideoModal() {
        const modal = document.getElementById('video-modal');
        const iframe = document.getElementById('video-iframe');
        iframe.src = '';  // Stop video
        modal.classList.add('hidden');
    }
    
    // Extract video ID from URL
    function extractVideoId(videoUrl) {
        if (!videoUrl) return '';
        if (videoUrl.includes('v=')) {
            return videoUrl.split('v=')[1].split('&')[0];
        } else if (videoUrl.includes('youtu.be/')) {
            return videoUrl.split('youtu.be/')[1].split('?')[0];
        } else if (videoUrl.includes('/embed/')) {
            return videoUrl.split('/embed/')[1].split('?')[0];
        } else {
            return videoUrl.split('/').pop();
        }
    }
    
    async function searchVideo(exerciseIndex, excludeIds = '') {
        const card = document.querySelector(`[data-exercise-index="${exerciseIndex}"]`);
        const videoSection = card.querySelector('.video-section');
        const exerciseId = videoSection.dataset.exerciseId;
        const exerciseName = videoSection.dataset.exerciseName;
        const searchBtn = videoSection.querySelector('.video-search-btn');
        const suggestionDiv = videoSection.querySelector('.video-suggestion');
        
        // Show loading
        searchBtn.innerHTML = `
            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span>Searching...</span>
        `;
        searchBtn.disabled = true;
        
        try {
            // Include exclude parameter if we have IDs to exclude
            let url = `/api/exercises/${exerciseId}/suggest-video?name=${encodeURIComponent(exerciseName)}`;
            if (excludeIds) {
                url += `&exclude=${encodeURIComponent(excludeIds)}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.video) {
                // Store this video URL for potential exclusion later
                videoSection.dataset.videoUrl = data.video.url;
                
                // Show suggestion for approval
                suggestionDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <button onclick="openVideoModal('${data.video.url}', '${exerciseName}')"
                                class="relative flex-shrink-0 w-24 h-16 rounded-lg overflow-hidden bg-dark-600 hover:ring-2 hover:ring-accent transition-all">
                            <img src="${data.video.thumbnail}" alt="Video thumbnail" class="w-full h-full object-cover">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </button>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-300 line-clamp-2">${data.video.title}</p>
                            <p class="text-xs text-gray-500">${data.video.channel}${data.video.duration ? ' Â· ' + formatDuration(data.video.duration) : ''}</p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="approveVideo('${exerciseId}', '${data.video.url}', ${exerciseIndex})"
                                        class="px-2 py-1 text-xs bg-accent text-dark-900 rounded hover:bg-accent/90">
                                    Use this
                                </button>
                                <button onclick="searchNewVideo(${exerciseIndex})"
                                        class="px-2 py-1 text-xs text-gray-400 hover:text-accent">
                                    Try another
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                suggestionDiv.classList.remove('hidden');
                searchBtn.classList.add('hidden');
            } else {
                // No video found
                searchBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>${excludeIds ? 'No more videos found' : 'No video found'}</span>
                `;
                searchBtn.disabled = false;
            }
        } catch (err) {
            console.error('Video search error:', err);
            searchBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Find demo video</span>
            `;
            searchBtn.disabled = false;
        }
    }
    
    function searchNewVideo(exerciseIndex) {
        const card = document.querySelector(`[data-exercise-index="${exerciseIndex}"]`);
        const videoSection = card.querySelector('.video-section');
        const exerciseId = videoSection.dataset.exerciseId;
        const exerciseName = videoSection.dataset.exerciseName;
        const currentVideoUrl = videoSection.dataset.videoUrl || '';
        
        // Extract current video ID to exclude
        const currentVideoId = extractVideoId(currentVideoUrl);
        
        // Get existing excluded IDs and add current one
        let excludedVideos = videoSection.dataset.excludedVideos || '';
        if (currentVideoId) {
            if (excludedVideos) {
                excludedVideos += ',' + currentVideoId;
            } else {
                excludedVideos = currentVideoId;
            }
        }
        
        // Store updated exclusions
        videoSection.dataset.excludedVideos = excludedVideos;
        videoSection.dataset.videoUrl = '';
        
        // Reset to empty state HTML so searchVideo can find the elements it needs
        videoSection.innerHTML = `
            <div class="video-empty">
                <button onclick="searchVideo(${exerciseIndex}, '${excludedVideos}')"
                        class="video-search-btn flex items-center gap-2 text-xs text-gray-500 hover:text-accent transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Find demo video</span>
                </button>
            </div>
            <div class="video-suggestion hidden mt-3"></div>
        `;
        
        // Restore excluded videos data attribute (innerHTML cleared it)
        videoSection.dataset.excludedVideos = excludedVideos;
        videoSection.dataset.exerciseId = exerciseId;
        videoSection.dataset.exerciseName = exerciseName;
        
        // Clear on server then search with exclusions
        fetch(`/api/exercises/${exerciseId}/clear-video`, { method: 'POST' })
            .then(() => searchVideo(exerciseIndex, excludedVideos))
            .catch(err => console.error('Clear video error:', err));
    }
    
    async function approveVideo(exerciseId, videoUrl, exerciseIndex) {
        try {
            const response = await fetch(`/api/exercises/${exerciseId}/save-video`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_url: videoUrl })
            });
            
            if (response.ok) {
                // Refresh the video section to show saved state
                const card = document.querySelector(`[data-exercise-index="${exerciseIndex}"]`);
                const videoSection = card.querySelector('.video-section');
                const exerciseName = videoSection.dataset.exerciseName;
                
                // Extract video ID for thumbnail
                const videoId = extractVideoId(videoUrl);
                
                // Update to saved state
                videoSection.innerHTML = `
                    <div class="video-saved flex items-center gap-3">
                        <button onclick="openVideoModal('${videoUrl}', '${exerciseName}')"
                                class="relative flex-shrink-0 w-24 h-16 rounded-lg overflow-hidden bg-dark-600 hover:ring-2 hover:ring-accent transition-all">
                            <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" 
                                 alt="Video thumbnail" class="w-full h-full object-cover">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </button>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 truncate">Demo video</p>
                            <button onclick="searchNewVideo(${exerciseIndex})" 
                                    class="text-xs text-gray-500 hover:text-accent transition-colors">
                                Find different video
                            </button>
                        </div>
                    </div>
                `;
                videoSection.dataset.videoUrl = videoUrl;
                videoSection.dataset.exerciseId = exerciseId;
                videoSection.dataset.exerciseName = exerciseName;
                videoSection.dataset.excludedVideos = '';  // Clear exclusions on approve
            }
        } catch (err) {
            console.error('Approve video error:', err);
            alert('Failed to save video');
        }
    }
    
    function formatDuration(seconds) {
        if (seconds < 60) return `0:${String(seconds).padStart(2, '0')}`;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${String(secs).padStart(2, '0')}`;
    }
</script>
{% endblock %}