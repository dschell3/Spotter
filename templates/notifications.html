{% extends "base.html" %}

{% block title %}Notifications{% endblock %}

{% block body %}
<!-- Toast Notification -->
<div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 transform transition-all duration-300 -translate-y-20 opacity-0">
    <div id="toast-content" class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg">
        <svg id="toast-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span id="toast-message" class="font-medium">Settings saved!</span>
    </div>
</div>

<!-- Phone Confirmation Modal -->
<div id="phone-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="closePhoneModal()"></div>
    <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto bg-dark-800 rounded-2xl p-6 border border-dark-600">
        <h3 class="text-lg font-semibold text-gray-100 mb-2">Confirm Phone Number</h3>
        <p class="text-gray-400 text-sm mb-4">
            We'll send workout reminders and important notifications to this number. Please double-check it's correct.
        </p>
        <div class="bg-dark-700 rounded-lg p-4 mb-4 text-center">
            <span id="phone-display" class="text-xl font-mono text-accent"></span>
        </div>
        <div class="flex gap-3">
            <button onclick="closePhoneModal()" 
                    class="flex-1 px-4 py-3 bg-dark-600 text-gray-300 rounded-xl font-medium hover:bg-dark-500 transition-colors">
                Edit
            </button>
            <button onclick="confirmPhone()" 
                    class="flex-1 px-4 py-3 bg-accent text-dark-900 rounded-xl font-semibold hover:bg-accent/90 transition-colors">
                Confirm
            </button>
        </div>
    </div>
</div>

<div class="min-h-full flex flex-col">
    <!-- Header -->
    <header class="bg-dark-800 border-b border-dark-600 px-4 py-4 safe-area-inset">
        <div class="max-w-lg mx-auto flex items-center justify-between">
            <a href="{{ url_for('profile') }}" class="flex items-center gap-2 text-gray-400 hover:text-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                <span class="text-sm">Profile</span>
            </a>
            
            <h1 class="text-lg font-semibold text-gray-100">Notifications</h1>
            
            <div class="w-16"></div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="flex-1 px-4 py-6">
        <div class="max-w-lg mx-auto space-y-6">
            
            <!-- Info Banner -->
            <div class="bg-accent/10 border border-accent/30 rounded-xl p-4">
                <div class="flex gap-3">
                    <svg class="w-5 h-5 text-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-sm text-gray-300">
                        Get reminded before your scheduled workouts and stay accountable with friendly nudges when you've been away.
                    </p>
                </div>
            </div>
            
            <!-- Contact Info Section -->
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="px-4 py-3 border-b border-dark-600">
                    <h2 class="font-semibold text-gray-100">Contact Info</h2>
                </div>
                
                <div class="p-4 space-y-4">
                    <!-- Email (read-only, from auth) -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email</label>
                        <div class="flex items-center gap-2">
                            <input type="email" 
                                   value="{{ user.email }}" 
                                   disabled
                                   class="flex-1 bg-dark-700/50 border border-dark-600 rounded-lg px-3 py-2 text-gray-400 cursor-not-allowed">
                            <span class="text-xs text-success flex items-center gap-1 w-24 justify-end">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Verified
                            </span>
                        </div>
                    </div>
                    
                    <!-- Phone Number -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Phone Number (for SMS)</label>
                        <div class="flex items-center gap-2">
                            <input type="tel" 
                                   id="phone-input"
                                   value="{{ preferences.phone_number if preferences and preferences.phone_number else '' }}"
                                   placeholder="(555) 123-4567"
                                   class="flex-1 bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-gray-100 placeholder-gray-500 focus:border-accent focus:outline-none">
                            <button onclick="savePhone()" 
                                    id="phone-save-btn"
                                    class="px-4 py-2 bg-dark-600 text-gray-300 rounded-lg font-medium hover:bg-dark-500 transition-colors disabled:opacity-50">
                                Save
                            </button>
                            <span class="text-xs text-success flex items-center gap-1 w-24 justify-end {% if not preferences or not preferences.phone_confirmed %}invisible{% endif %}" id="phone-confirmed-badge">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Confirmed
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Workout Reminders Section -->
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="px-4 py-3 border-b border-dark-600 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-100">Workout Reminders</h2>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" 
                               id="workout-reminder-toggle"
                               {% if preferences and preferences.workout_reminder_enabled %}checked{% endif %}
                               onchange="toggleWorkoutReminders(this.checked)"
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                    </label>
                </div>
                
                <div id="workout-reminder-settings" class="p-4 space-y-4 {% if not preferences or not preferences.workout_reminder_enabled %}opacity-50 pointer-events-none{% endif %}">
                    <p class="text-sm text-gray-400">Get a reminder before your scheduled workouts.</p>
                    
                    <!-- Hours Before -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Remind me</label>
                        <div class="flex flex-wrap gap-2">
                            {% for hours in [1, 2, 3, 4, 6, 12, 24] %}
                            <button onclick="setReminderHours({{ hours }})"
                                    data-hours="{{ hours }}"
                                    class="reminder-hours-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors
                                           {% if (preferences and preferences.workout_reminder_hours == hours) or (not preferences and hours == 2) %}
                                           bg-accent text-dark-900
                                           {% else %}
                                           bg-dark-700 text-gray-300 hover:bg-dark-600
                                           {% endif %}">
                                {{ hours }}h before
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Channel -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Send via</label>
                        <div class="flex gap-2">
                            <button onclick="setReminderChannel('email')"
                                    id="channel-email"
                                    class="flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2
                                           {% if not preferences or preferences.workout_reminder_channel != 'sms' %}
                                           bg-accent text-dark-900
                                           {% else %}
                                           bg-dark-700 text-gray-300 hover:bg-dark-600
                                           {% endif %}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                Email
                            </button>
                            <button onclick="setReminderChannel('sms')"
                                    id="channel-sms"
                                    class="flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2
                                           {% if preferences and preferences.workout_reminder_channel == 'sms' %}
                                           bg-accent text-dark-900
                                           {% else %}
                                           bg-dark-700 text-gray-300 hover:bg-dark-600
                                           {% endif %}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                SMS
                            </button>
                        </div>
                        <p id="sms-phone-warning" class="text-xs text-warning mt-2 hidden">
                            Add a phone number above to enable SMS reminders.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Inactivity Nudges Section -->
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="px-4 py-3 border-b border-dark-600 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-100">Inactivity Nudges</h2>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" 
                               id="inactivity-nudge-toggle"
                               {% if preferences and preferences.inactivity_nudge_enabled %}checked{% endif %}
                               onchange="toggleInactivityNudges(this.checked)"
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                    </label>
                </div>
                
                <div id="inactivity-settings" class="p-4 space-y-4 {% if not preferences or not preferences.inactivity_nudge_enabled %}opacity-50 pointer-events-none{% endif %}">
                    <p class="text-sm text-gray-400">Get a friendly reminder when you've been away for a while.</p>
                    
                    <!-- Week Nudge -->
                    <div class="flex items-center justify-between p-3 bg-dark-700 rounded-lg">
                        <div>
                            <p class="text-gray-100 font-medium">1 Week Inactive</p>
                            <p class="text-xs text-gray-500">Gentle email reminder</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="week-nudge-toggle"
                                   {% if not preferences or preferences.inactivity_week_via_email != false %}checked{% endif %}
                                   onchange="updateInactivitySetting('inactivity_week_via_email', this.checked)"
                                   class="sr-only peer">
                            <div class="w-9 h-5 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent"></div>
                        </label>
                    </div>
                    
                    <!-- Month Nudge -->
                    <div class="flex items-center justify-between p-3 bg-dark-700 rounded-lg">
                        <div>
                            <p class="text-gray-100 font-medium">1 Month Inactive</p>
                            <p class="text-xs text-gray-500">SMS nudge (more urgent)</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="month-nudge-toggle"
                                   {% if preferences and preferences.inactivity_month_via_sms %}checked{% endif %}
                                   onchange="updateInactivitySetting('inactivity_month_via_sms', this.checked)"
                                   class="sr-only peer">
                            <div class="w-9 h-5 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Test Notifications Section (Development) -->
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="px-4 py-3 border-b border-dark-600">
                    <h2 class="font-semibold text-gray-100">Test Notifications</h2>
                </div>
                
                <div class="p-4 space-y-4">
                    <div>
                        <p class="text-sm text-gray-400 mb-2">Send a test email to yourself:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="sendTestEmail('workout_reminder')"
                                    class="px-4 py-2 bg-dark-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-dark-600 transition-colors">
                                Test Workout Reminder
                            </button>
                            <button onclick="sendTestEmail('inactivity_week')"
                                    class="px-4 py-2 bg-dark-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-dark-600 transition-colors">
                                Test Week Nudge
                            </button>
                            <button onclick="sendTestEmail('inactivity_month')"
                                    class="px-4 py-2 bg-dark-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-dark-600 transition-colors">
                                Test Month Nudge
                            </button>
                        </div>
                    </div>
                    
                    {% if preferences and preferences.phone_number %}
                    <div>
                        <p class="text-sm text-gray-400 mb-2">Send a test SMS to your phone:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="sendTestSms('workout_reminder')"
                                    class="px-4 py-2 bg-dark-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-dark-600 transition-colors">
                                ðŸ“± Test SMS Reminder
                            </button>
                            <button onclick="sendTestSms('welcome')"
                                    class="px-4 py-2 bg-dark-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-dark-600 transition-colors">
                                ðŸ“± Test Welcome SMS
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <p id="test-result" class="text-sm hidden"></p>
                </div>
            </div>
            
            <!-- Footer Info -->
            <p class="text-xs text-gray-500 text-center px-4">
                You can change or disable notifications at any time. We'll never spam you.
            </p>
            
        </div>
    </main>
</div>

<script>
    // State
    let currentPrefs = {{ preferences | tojson | safe if preferences else '{}' }};
    let pendingPhone = null;
    
    // Toast helper
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const content = document.getElementById('toast-content');
        const msg = document.getElementById('toast-message');
        
        content.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg ${isError ? 'bg-red-600' : 'bg-success'}`;
        msg.textContent = message;
        
        toast.classList.remove('-translate-y-20', 'opacity-0');
        toast.classList.add('translate-y-0', 'opacity-100');
        
        setTimeout(() => {
            toast.classList.add('-translate-y-20', 'opacity-0');
            toast.classList.remove('translate-y-0', 'opacity-100');
        }, 3000);
    }
    
    // API helper
    async function updatePreferences(updates) {
        try {
            const response = await fetch('/api/notifications/preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                currentPrefs = { ...currentPrefs, ...updates };
                showToast('Settings saved!');
                return true;
            } else {
                showToast(data.error || 'Failed to save', true);
                return false;
            }
        } catch (err) {
            console.error('Update error:', err);
            showToast('Connection error', true);
            return false;
        }
    }
    
    // Phone handling
    function savePhone() {
        const phone = document.getElementById('phone-input').value.trim();
        
        if (!phone) {
            // Clearing phone number
            updatePhoneNumber('', false);
            return;
        }
        
        // Show confirmation modal
        pendingPhone = phone;
        document.getElementById('phone-display').textContent = formatPhone(phone);
        document.getElementById('phone-modal').classList.remove('hidden');
    }
    
    function closePhoneModal() {
        document.getElementById('phone-modal').classList.add('hidden');
        pendingPhone = null;
    }
    
    async function confirmPhone() {
        if (!pendingPhone) return;
        
        await updatePhoneNumber(pendingPhone, true);
        closePhoneModal();
    }
    
    async function updatePhoneNumber(phone, confirmed) {
        try {
            const response = await fetch('/api/notifications/phone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone_number: phone, confirmed })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                currentPrefs.phone_number = phone;
                currentPrefs.phone_confirmed = confirmed;
                showToast(phone ? 'Phone number saved!' : 'Phone number removed');
                checkSmsAvailability();
            } else {
                showToast(data.error || 'Failed to save', true);
            }
        } catch (err) {
            showToast('Connection error', true);
        }
    }
    
    function formatPhone(phone) {
        const clean = phone.replace(/\D/g, '');
        if (clean.length === 10) {
            return `(${clean.slice(0,3)}) ${clean.slice(3,6)}-${clean.slice(6)}`;
        }
        return phone;
    }
    
    // Workout reminders
    function toggleWorkoutReminders(enabled) {
        const settings = document.getElementById('workout-reminder-settings');
        
        if (enabled) {
            settings.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            settings.classList.add('opacity-50', 'pointer-events-none');
        }
        
        updatePreferences({ workout_reminder_enabled: enabled });
    }
    
    function setReminderHours(hours) {
        // Update button states
        document.querySelectorAll('.reminder-hours-btn').forEach(btn => {
            const btnHours = parseInt(btn.dataset.hours);
            if (btnHours === hours) {
                btn.classList.remove('bg-dark-700', 'text-gray-300', 'hover:bg-dark-600');
                btn.classList.add('bg-accent', 'text-dark-900');
            } else {
                btn.classList.add('bg-dark-700', 'text-gray-300', 'hover:bg-dark-600');
                btn.classList.remove('bg-accent', 'text-dark-900');
            }
        });
        
        updatePreferences({ workout_reminder_hours: hours });
    }
    
    function setReminderChannel(channel) {
        const hasPhone = currentPrefs.phone_number;
        
        if (channel === 'sms' && !hasPhone) {
            document.getElementById('sms-phone-warning').classList.remove('hidden');
            return;
        }
        
        document.getElementById('sms-phone-warning').classList.add('hidden');
        
        // Update button states
        const emailBtn = document.getElementById('channel-email');
        const smsBtn = document.getElementById('channel-sms');
        
        if (channel === 'email') {
            emailBtn.classList.remove('bg-dark-700', 'text-gray-300', 'hover:bg-dark-600');
            emailBtn.classList.add('bg-accent', 'text-dark-900');
            smsBtn.classList.add('bg-dark-700', 'text-gray-300', 'hover:bg-dark-600');
            smsBtn.classList.remove('bg-accent', 'text-dark-900');
        } else {
            smsBtn.classList.remove('bg-dark-700', 'text-gray-300', 'hover:bg-dark-600');
            smsBtn.classList.add('bg-accent', 'text-dark-900');
            emailBtn.classList.add('bg-dark-700', 'text-gray-300', 'hover:bg-dark-600');
            emailBtn.classList.remove('bg-accent', 'text-dark-900');
        }
        
        updatePreferences({ workout_reminder_channel: channel });
    }
    
    function checkSmsAvailability() {
        const hasPhone = currentPrefs.phone_number;
        const warning = document.getElementById('sms-phone-warning');
        
        if (!hasPhone && currentPrefs.workout_reminder_channel === 'sms') {
            warning.classList.remove('hidden');
            setReminderChannel('email');
        } else {
            warning.classList.add('hidden');
        }
    }
    
    // Inactivity nudges
    function toggleInactivityNudges(enabled) {
        const settings = document.getElementById('inactivity-settings');
        
        if (enabled) {
            settings.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            settings.classList.add('opacity-50', 'pointer-events-none');
        }
        
        updatePreferences({ inactivity_nudge_enabled: enabled });
    }
    
    function updateInactivitySetting(key, value) {
        const updates = {};
        updates[key] = value;
        
        // Check if SMS is being enabled without phone
        if (key === 'inactivity_month_via_sms' && value && !currentPrefs.phone_number) {
            showToast('Add a phone number first', true);
            document.getElementById('month-nudge-toggle').checked = false;
            return;
        }
        
        updatePreferences(updates);
    }
    
    // Init
    document.addEventListener('DOMContentLoaded', () => {
        checkSmsAvailability();
    });
    
    // Test email
    async function sendTestEmail(type) {
        const resultEl = document.getElementById('test-result');
        resultEl.textContent = 'Sending email...';
        resultEl.className = 'text-sm text-gray-400';
        resultEl.classList.remove('hidden');
        
        try {
            const response = await fetch('/api/cron/test-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                resultEl.textContent = 'âœ“ Test email sent! Check your inbox.';
                resultEl.className = 'text-sm text-success';
            } else {
                resultEl.textContent = 'âœ— ' + (data.error || 'Failed to send');
                resultEl.className = 'text-sm text-red-400';
            }
        } catch (err) {
            resultEl.textContent = 'âœ— Connection error';
            resultEl.className = 'text-sm text-red-400';
        }
    }
    
    // Test SMS
    async function sendTestSms(type) {
        const resultEl = document.getElementById('test-result');
        resultEl.textContent = 'Sending SMS...';
        resultEl.className = 'text-sm text-gray-400';
        resultEl.classList.remove('hidden');
        
        try {
            const response = await fetch('/api/cron/test-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                resultEl.textContent = 'âœ“ Test SMS sent! Check your phone.';
                resultEl.className = 'text-sm text-success';
            } else {
                resultEl.textContent = 'âœ— ' + (data.error || 'Failed to send');
                resultEl.className = 'text-sm text-red-400';
            }
        } catch (err) {
            resultEl.textContent = 'âœ— Connection error';
            resultEl.className = 'text-sm text-red-400';
        }
    }
</script>
{% endblock %}