{% extends "base.html" %}

{% block title %}New Cycle{% endblock %}

{% block body %}
<div class="min-h-full flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-dark-800/95 backdrop-blur border-b border-dark-600 px-4 py-3 safe-area-inset">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <a href="{{ url_for('plan') }}" class="flex items-center gap-2 text-gray-400 hover:text-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                <span class="text-sm">Cancel</span>
            </a>
            
            <h1 class="text-base font-semibold text-gray-100">New Training Cycle</h1>
            
            <div class="w-16"></div>
        </div>
    </header>
    
    <!-- Progress Steps -->
    <div class="bg-dark-800 border-b border-dark-700 px-4 py-3">
        <div class="max-w-2xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2" id="step-1-indicator">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-accent text-dark-900 text-xs font-bold">1</span>
                    <span class="text-sm text-gray-300">Setup</span>
                </div>
                <div class="flex-1 h-0.5 bg-dark-600 mx-3">
                    <div id="progress-line-1" class="h-full bg-accent transition-all" style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2" id="step-2-indicator">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-dark-600 text-gray-500 text-xs font-bold">2</span>
                    <span class="text-sm text-gray-500">Schedule</span>
                </div>
                <div class="flex-1 h-0.5 bg-dark-600 mx-3">
                    <div id="progress-line-2" class="h-full bg-accent transition-all" style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2" id="step-3-indicator">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-dark-600 text-gray-500 text-xs font-bold">3</span>
                    <span class="text-sm text-gray-500">Exercises</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="flex-1 px-4 py-6">
        <div class="max-w-2xl mx-auto">
            
            <!-- Step 1: Basic Setup -->
            <div id="step-1" class="step-content">
                <h2 class="text-xl font-semibold text-gray-100 mb-6">Set Up Your Cycle</h2>
                
                <!-- Copy from Previous Option -->
                {% if previous_cycle %}
                <div class="mb-6 p-4 bg-dark-800 border border-dark-600 rounded-xl">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="copy-previous" 
                               class="mt-1 w-5 h-5 rounded border-dark-500 bg-dark-700 text-accent focus:ring-accent">
                        <div>
                            <span class="font-medium text-gray-100">Copy from previous cycle</span>
                            <p class="text-sm text-gray-500 mt-1">
                                Start with exercises from "{{ previous_cycle.name }}" and make adjustments
                            </p>
                        </div>
                    </label>
                </div>
                {% endif %}
                
                <div class="space-y-5 bg-dark-800 border border-dark-600 rounded-xl p-5">
                    <!-- Cycle Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Cycle Name (optional)</label>
                        <input type="text" id="cycle-name" 
                               placeholder="e.g., Spring Cut, Strength Block"
                               class="w-full bg-dark-700 border border-dark-500 rounded-lg px-4 py-3 text-gray-100 placeholder-gray-600 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent">
                    </div>
                    
                    <!-- Split Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Training Split</label>
                        <select id="split-type" 
                                class="w-full bg-dark-700 border border-dark-500 rounded-lg px-4 py-3 text-gray-100 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent">
                            <option value="ppl_3day" {{ 'selected' if profile and profile.split_type == 'ppl_3day' else '' }}>PPL × 2 (3 days/week)</option>
                            <option value="ppl_6day" {{ 'selected' if profile and profile.split_type == 'ppl_6day' else '' }}>PPL (6 days/week)</option>
                            <option value="upper_lower_4day" {{ 'selected' if profile and profile.split_type == 'upper_lower_4day' else '' }}>Upper/Lower (4 days/week)</option>
                            <option value="full_body_3day" {{ 'selected' if profile and profile.split_type == 'full_body_3day' else '' }}>Full Body (3 days/week)</option>
                        </select>
                    </div>
                    
                    <!-- Cycle Length -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Cycle Length</label>
                        <div class="grid grid-cols-3 gap-3">
                            {% for weeks in [4, 6, 8] %}
                            <button type="button" onclick="selectCycleLength({{ weeks }})"
                                    class="cycle-length-btn py-3 rounded-lg border text-center transition-colors
                                           {{ 'bg-accent border-accent text-dark-900' if (profile and profile.cycle_length_weeks == weeks) or (not profile and weeks == 6) else 'bg-dark-700 border-dark-500 text-gray-400 hover:border-gray-500' }}"
                                    data-weeks="{{ weeks }}">
                                {{ weeks }} weeks
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Start Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Start Date</label>
                        <input type="date" id="start-date" 
                               value="{{ next_monday.isoformat() }}"
                               min="{{ today.isoformat() }}"
                               class="w-full bg-dark-700 border border-dark-500 rounded-lg px-4 py-3 text-gray-100 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent">
                        <p class="text-xs text-gray-500 mt-1">Cycles start on Monday</p>
                    </div>
                </div>
                
                <button onclick="goToStep(2)" 
                        class="w-full mt-6 py-3 bg-accent hover:bg-accent/90 text-dark-900 font-semibold rounded-xl transition-colors">
                    Continue
                </button>
            </div>
            
            <!-- Step 2: Schedule -->
            <div id="step-2" class="step-content hidden">
                <h2 class="text-xl font-semibold text-gray-100 mb-2">Set Your Schedule</h2>
                <p class="text-gray-500 mb-6">Choose which days you'll train each week</p>
                
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-5">
                    <div id="schedule-grid" class="space-y-3">
                        <!-- Populated dynamically based on split type -->
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="goToStep(1)" 
                            class="flex-1 py-3 border border-dark-600 text-gray-400 rounded-xl hover:bg-dark-800 transition-colors">
                        Back
                    </button>
                    <button onclick="goToStep(3)" 
                            class="flex-1 py-3 bg-accent hover:bg-accent/90 text-dark-900 font-semibold rounded-xl transition-colors">
                        Continue
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Exercises -->
            <div id="step-3" class="step-content hidden">
                <h2 class="text-xl font-semibold text-gray-100 mb-2">Review Exercises</h2>
                <p class="text-gray-500 mb-6">These exercises will be used throughout your cycle. Tap to swap.</p>
                
                <div id="exercises-review" class="space-y-4">
                    <!-- Populated dynamically -->
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="goToStep(2)" 
                            class="flex-1 py-3 border border-dark-600 text-gray-400 rounded-xl hover:bg-dark-800 transition-colors">
                        Back
                    </button>
                    <button onclick="createCycle()" id="create-btn"
                            class="flex-1 py-3 bg-accent hover:bg-accent/90 text-dark-900 font-semibold rounded-xl transition-colors">
                        Create Cycle
                    </button>
                </div>
            </div>
            
        </div>
    </main>
</div>

<!-- Exercise Swap Modal -->
<div id="swap-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="closeSwapModal()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-dark-800 rounded-t-2xl max-h-[80vh] overflow-hidden">
        <div class="p-4 border-b border-dark-600">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold text-gray-100">Swap Exercise</h3>
                <button onclick="closeSwapModal()" class="text-gray-500 hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p id="swap-modal-subtitle" class="text-sm text-gray-500 mt-1"></p>
        </div>
        <div id="swap-options" class="p-4 overflow-y-auto max-h-[60vh] space-y-2">
            <!-- Populated dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Cycle configuration state
    let cycleConfig = {
        name: '',
        splitType: '{{ profile.split_type if profile else "ppl_3day" }}',
        lengthWeeks: {{ profile.cycle_length_weeks if profile and profile.cycle_length_weeks else 6 }},
        startDate: '{{ next_monday.isoformat() }}',
        copyPrevious: false,
        schedule: [],
        exercises: {}
    };
    
    // Default workout structures for each split type
    const splitStructures = {
        'ppl_3day': [
            { name: 'Push (Heavy) + Pull (Light)', heavyFocus: ['push'], muscles: ['chest', 'shoulders', 'triceps', 'back', 'biceps'] },
            { name: 'Legs (Heavy) + Push (Light)', heavyFocus: ['legs'], muscles: ['quads', 'hamstrings', 'glutes', 'calves', 'chest', 'shoulders'] },
            { name: 'Pull (Heavy) + Legs (Light)', heavyFocus: ['pull'], muscles: ['back', 'biceps', 'rear_delts', 'hamstrings', 'glutes'] }
        ],
        'ppl_6day': [
            { name: 'Push', heavyFocus: ['push'], muscles: ['chest', 'shoulders', 'triceps'] },
            { name: 'Pull', heavyFocus: ['pull'], muscles: ['back', 'biceps', 'rear_delts'] },
            { name: 'Legs', heavyFocus: ['legs'], muscles: ['quads', 'hamstrings', 'glutes', 'calves'] },
            { name: 'Push', heavyFocus: ['push'], muscles: ['chest', 'shoulders', 'triceps'] },
            { name: 'Pull', heavyFocus: ['pull'], muscles: ['back', 'biceps', 'rear_delts'] },
            { name: 'Legs', heavyFocus: ['legs'], muscles: ['quads', 'hamstrings', 'glutes', 'calves'] }
        ],
        'upper_lower_4day': [
            { name: 'Upper (Heavy)', heavyFocus: ['upper'], muscles: ['chest', 'back', 'shoulders', 'biceps', 'triceps'] },
            { name: 'Lower (Heavy)', heavyFocus: ['lower'], muscles: ['quads', 'hamstrings', 'glutes', 'calves'] },
            { name: 'Upper (Light)', heavyFocus: [], muscles: ['chest', 'back', 'shoulders', 'biceps', 'triceps'] },
            { name: 'Lower (Light)', heavyFocus: [], muscles: ['quads', 'hamstrings', 'glutes', 'calves'] }
        ],
        'full_body_3day': [
            { name: 'Full Body A', heavyFocus: ['compound'], muscles: ['chest', 'back', 'quads', 'shoulders'] },
            { name: 'Full Body B', heavyFocus: ['compound'], muscles: ['back', 'chest', 'hamstrings', 'biceps', 'triceps'] },
            { name: 'Full Body C', heavyFocus: ['compound'], muscles: ['quads', 'glutes', 'shoulders', 'back'] }
        ]
    };
    
    // Default day assignments
    const defaultDays = {
        'ppl_3day': [0, 2, 4],      // Mon, Wed, Fri
        'ppl_6day': [0, 1, 2, 3, 4, 5], // Mon-Sat
        'upper_lower_4day': [0, 1, 3, 4], // Mon, Tue, Thu, Fri
        'full_body_3day': [0, 2, 4]  // Mon, Wed, Fri
    };
    
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    let currentStep = 1;
    let swapTarget = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        updateScheduleGrid();
        
        // Event listeners
        document.getElementById('cycle-name').addEventListener('change', e => {
            cycleConfig.name = e.target.value;
        });
        
        document.getElementById('split-type').addEventListener('change', e => {
            cycleConfig.splitType = e.target.value;
            updateScheduleGrid();
        });
        
        document.getElementById('start-date').addEventListener('change', e => {
            cycleConfig.startDate = e.target.value;
        });
        
        {% if previous_cycle %}
        document.getElementById('copy-previous').addEventListener('change', e => {
            cycleConfig.copyPrevious = e.target.checked;
        });
        {% endif %}
    });
    
    function selectCycleLength(weeks) {
        cycleConfig.lengthWeeks = weeks;
        document.querySelectorAll('.cycle-length-btn').forEach(btn => {
            if (parseInt(btn.dataset.weeks) === weeks) {
                btn.classList.remove('bg-dark-700', 'border-dark-500', 'text-gray-400');
                btn.classList.add('bg-accent', 'border-accent', 'text-dark-900');
            } else {
                btn.classList.add('bg-dark-700', 'border-dark-500', 'text-gray-400');
                btn.classList.remove('bg-accent', 'border-accent', 'text-dark-900');
            }
        });
    }
    
    function updateScheduleGrid() {
        const grid = document.getElementById('schedule-grid');
        const structure = splitStructures[cycleConfig.splitType];
        const defaults = defaultDays[cycleConfig.splitType];
        
        cycleConfig.schedule = defaults.map((day, i) => ({
            workoutIndex: i,
            dayOfWeek: day
        }));
        
        grid.innerHTML = structure.map((workout, i) => `
            <div class="flex items-center gap-4 p-3 bg-dark-700 rounded-lg">
                <div class="flex-1">
                    <p class="font-medium text-gray-100">${workout.name}</p>
                    <p class="text-xs text-gray-500">${workout.muscles.slice(0, 3).join(', ')}</p>
                </div>
                <select onchange="updateWorkoutDay(${i}, this.value)"
                        class="bg-dark-600 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 text-sm focus:outline-none focus:border-accent">
                    ${dayNames.map((name, d) => `
                        <option value="${d}" ${defaults[i] === d ? 'selected' : ''}>${name}</option>
                    `).join('')}
                </select>
            </div>
        `).join('');
    }
    
    function updateWorkoutDay(workoutIndex, day) {
        cycleConfig.schedule[workoutIndex].dayOfWeek = parseInt(day);
    }
    
    function goToStep(step) {
        // Update indicators
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step-${i}-indicator`);
            const circle = indicator.querySelector('span:first-child');
            const text = indicator.querySelector('span:last-child');
            
            if (i < step) {
                circle.classList.remove('bg-dark-600', 'text-gray-500');
                circle.classList.add('bg-success', 'text-white');
                text.classList.remove('text-gray-500');
                text.classList.add('text-gray-300');
            } else if (i === step) {
                circle.classList.remove('bg-dark-600', 'text-gray-500', 'bg-success', 'text-white');
                circle.classList.add('bg-accent', 'text-dark-900');
                text.classList.remove('text-gray-500');
                text.classList.add('text-gray-300');
            } else {
                circle.classList.remove('bg-accent', 'text-dark-900', 'bg-success', 'text-white');
                circle.classList.add('bg-dark-600', 'text-gray-500');
                text.classList.add('text-gray-500');
                text.classList.remove('text-gray-300');
            }
        }
        
        // Update progress lines
        document.getElementById('progress-line-1').style.width = step > 1 ? '100%' : '0%';
        document.getElementById('progress-line-2').style.width = step > 2 ? '100%' : '0%';
        
        // Show/hide steps
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`step-${i}`).classList.toggle('hidden', i !== step);
        }
        
        currentStep = step;
        
        // Load exercises for step 3
        if (step === 3) {
            loadExercisesForReview();
        }
    }
    
    async function loadExercisesForReview() {
        const container = document.getElementById('exercises-review');
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Loading exercises...</div>';
        
        try {
            const response = await fetch('/api/exercises');
            const allExercises = await response.json();
            
            const structure = splitStructures[cycleConfig.splitType];
            
            container.innerHTML = structure.map((workout, wIdx) => {
                // Get exercises for this workout's muscle groups
                const workoutExercises = getDefaultExercisesForWorkout(workout, allExercises);
                cycleConfig.exercises[wIdx] = workoutExercises;
                
                return `
                    <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                        <div class="px-4 py-3 bg-dark-700 border-b border-dark-600">
                            <h4 class="font-medium text-gray-100">${workout.name}</h4>
                        </div>
                        <div class="p-3 space-y-2">
                            ${workoutExercises.map((ex, eIdx) => `
                                <button onclick="openSwapModal(${wIdx}, ${eIdx})"
                                        class="w-full flex items-center justify-between p-3 bg-dark-700 rounded-lg hover:bg-dark-600 transition-colors text-left"
                                        data-workout="${wIdx}" data-exercise="${eIdx}">
                                    <div>
                                        <p class="text-gray-100 text-sm">${ex.name}</p>
                                        <p class="text-xs text-gray-500 capitalize">${ex.muscle_group} · ${ex.equipment || 'bodyweight'}</p>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                    </svg>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (err) {
            console.error('Failed to load exercises:', err);
            container.innerHTML = '<div class="text-center py-8 text-red-400">Failed to load exercises</div>';
        }
    }
    
    function getDefaultExercisesForWorkout(workout, allExercises) {
        // Simple algorithm: pick 6-8 exercises covering the muscle groups
        const exercises = [];
        const muscleGroups = workout.muscles;
        
        // Prioritize compound exercises first
        for (const muscle of muscleGroups) {
            const muscleExercises = allExercises.filter(e => 
                e.muscle_group === muscle && !exercises.find(ex => ex.id === e.id)
            );
            
            const compound = muscleExercises.find(e => e.is_compound);
            if (compound && exercises.length < 8) {
                exercises.push(compound);
            }
        }
        
        // Fill with isolation exercises
        for (const muscle of muscleGroups) {
            const muscleExercises = allExercises.filter(e => 
                e.muscle_group === muscle && !exercises.find(ex => ex.id === e.id)
            );
            
            const isolation = muscleExercises.find(e => !e.is_compound);
            if (isolation && exercises.length < 8) {
                exercises.push(isolation);
            }
        }
        
        return exercises.slice(0, 8);
    }
    
    async function openSwapModal(workoutIdx, exerciseIdx) {
        const exercise = cycleConfig.exercises[workoutIdx][exerciseIdx];
        swapTarget = { workoutIdx, exerciseIdx };
        
        document.getElementById('swap-modal-subtitle').textContent = 
            `Replace ${exercise.name} (${exercise.muscle_group})`;
        
        const optionsContainer = document.getElementById('swap-options');
        optionsContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Loading...</div>';
        
        document.getElementById('swap-modal').classList.remove('hidden');
        
        try {
            const response = await fetch(`/api/exercises/${exercise.muscle_group}/substitutes?current=${exercise.id}&equipment=${exercise.equipment || ''}`);
            const substitutes = await response.json();
            
            optionsContainer.innerHTML = substitutes.map(sub => `
                <button onclick="swapExercise('${sub.id}', '${sub.name}', '${sub.muscle_group}', '${sub.equipment || ''}')"
                        class="w-full flex items-center justify-between p-4 bg-dark-700 rounded-lg hover:bg-dark-600 transition-colors text-left">
                    <div>
                        <p class="text-gray-100">${sub.name}</p>
                        <p class="text-sm text-gray-500 capitalize">${sub.equipment || 'bodyweight'}</p>
                    </div>
                    ${sub.equipment === exercise.equipment ? '<span class="text-xs text-accent">Same equipment</span>' : ''}
                </button>
            `).join('') || '<div class="text-center py-4 text-gray-500">No alternatives found</div>';
        } catch (err) {
            console.error('Failed to load substitutes:', err);
            optionsContainer.innerHTML = '<div class="text-center py-4 text-red-400">Failed to load</div>';
        }
    }
    
    function closeSwapModal() {
        document.getElementById('swap-modal').classList.add('hidden');
        swapTarget = null;
    }
    
    function swapExercise(id, name, muscleGroup, equipment) {
        if (!swapTarget) return;
        
        const { workoutIdx, exerciseIdx } = swapTarget;
        cycleConfig.exercises[workoutIdx][exerciseIdx] = {
            id, name, muscle_group: muscleGroup, equipment
        };
        
        // Update UI
        const btn = document.querySelector(`button[data-workout="${workoutIdx}"][data-exercise="${exerciseIdx}"]`);
        if (btn) {
            btn.querySelector('p.text-gray-100').textContent = name;
            btn.querySelector('p.text-xs').textContent = `${muscleGroup} · ${equipment || 'bodyweight'}`;
        }
        
        closeSwapModal();
    }
    
    async function createCycle() {
        const btn = document.getElementById('create-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';
        
        try {
            const response = await fetch('/api/cycle/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: cycleConfig.name || `Cycle ${new Date().toLocaleDateString()}`,
                    split_type: cycleConfig.splitType,
                    length_weeks: cycleConfig.lengthWeeks,
                    start_date: cycleConfig.startDate,
                    copy_previous: cycleConfig.copyPrevious,
                    schedule: cycleConfig.schedule,
                    exercises: cycleConfig.exercises
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                window.location.href = `/cycle/${data.cycle_id}`;
            } else {
                throw new Error('Failed to create cycle');
            }
        } catch (err) {
            console.error('Create cycle error:', err);
            btn.textContent = 'Error - Try Again';
            btn.disabled = false;
            
            setTimeout(() => {
                btn.textContent = 'Create Cycle';
            }, 2000);
        }
    }
</script>
{% endblock %}