{% extends "base.html" %}

{% block title %}New Cycle{% endblock %}

{% block head %}
<style>
    .dragging {
        opacity: 0.5;
    }
    .drag-over {
        border-color: #22d3ee !important;
        background: rgba(34, 211, 238, 0.1) !important;
    }
    .drag-handle {
        cursor: grab;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    .generating {
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .week-tab {
        transition: all 0.2s;
    }
    .week-tab.active {
        background: rgba(34, 211, 238, 0.2);
        border-color: #22d3ee;
        color: #22d3ee;
    }
    .week-tab:not(.active):hover {
        background: rgba(255, 255, 255, 0.05);
    }
</style>
{% endblock %}

{% block body %}
<div class="min-h-full flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-dark-800/95 backdrop-blur border-b border-dark-600 px-4 py-3 safe-area-inset">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <a href="{{ url_for('plan') }}" class="flex items-center gap-2 text-gray-400 hover:text-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                <span class="text-sm">Cancel</span>
            </a>
            <h1 class="text-base font-semibold text-gray-100">New Training Cycle</h1>
            <div class="w-16"></div>
        </div>
    </header>
    
    <!-- Progress Steps -->
    <div class="bg-dark-800 border-b border-dark-700 px-4 py-3">
        <div class="max-w-2xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2" id="step-1-indicator">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-accent text-dark-900 text-xs font-bold">1</span>
                    <span class="text-sm text-gray-300">Setup</span>
                </div>
                <div class="flex-1 h-0.5 bg-dark-600 mx-3"><div id="progress-line-1" class="h-full bg-accent transition-all" style="width: 0%"></div></div>
                <div class="flex items-center gap-2" id="step-2-indicator">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-dark-600 text-gray-500 text-xs font-bold">2</span>
                    <span class="text-sm text-gray-500">Schedule</span>
                </div>
                <div class="flex-1 h-0.5 bg-dark-600 mx-3"><div id="progress-line-2" class="h-full bg-accent transition-all" style="width: 0%"></div></div>
                <div class="flex items-center gap-2" id="step-3-indicator">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-dark-600 text-gray-500 text-xs font-bold">3</span>
                    <span class="text-sm text-gray-500">Exercises</span>
                </div>
            </div>
        </div>
    </div>
    
    <main class="flex-1 px-4 py-6 pb-24">
        <div class="max-w-2xl mx-auto">
            
            <!-- Step 1: Basic Setup -->
            <div id="step-1" class="step-content">
                <h2 class="text-xl font-semibold text-gray-100 mb-6">Set Up Your Cycle</h2>
                
                <div class="space-y-5 bg-dark-800 border border-dark-600 rounded-xl p-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Cycle Name (optional)</label>
                        <input type="text" id="cycle-name" placeholder="e.g., Spring Cut, Strength Block"
                               class="w-full bg-dark-700 border border-dark-500 rounded-lg px-4 py-3 text-gray-100 placeholder-gray-600 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent">
                    </div>
                    
                    <!-- Split Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Training Split</label>
                        <div class="grid grid-cols-2 gap-2">
                            {% set current_split = profile.split_type if profile and profile.split_type else 'ppl' %}
                            {% set splits = [
                                ('full_body', 'Full Body', 'All muscles each session'),
                                ('upper_lower', 'Upper / Lower', 'Alternate upper & lower'),
                                ('ppl', 'Push / Pull / Legs', 'Classic bodybuilding split'),
                                ('custom', 'Custom', 'Build your own')
                            ] %}
                            {% for value, label, desc in splits %}
                            <button type="button" onclick="selectSplit('{{ value }}')"
                                    class="split-btn p-3 rounded-lg border text-left transition-colors
                                           {{ 'bg-accent/20 border-accent text-accent' if current_split == value or (current_split in ['ppl_3day', 'ppl_6day'] and value == 'ppl') else 'bg-dark-700 border-dark-500 text-gray-400 hover:border-gray-500' }}"
                                    data-split="{{ value }}">
                                <span class="block font-medium text-sm">{{ label }}</span>
                                <span class="block text-xs opacity-70 mt-0.5">{{ desc }}</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Training Days Per Week</label>
                        <div class="grid grid-cols-5 gap-2">
                            {% set default_days = profile.days_per_week if profile and profile.days_per_week else 3 %}
                            {% for day in [2, 3, 4, 5, 6] %}
                            <button type="button" onclick="selectDaysPerWeek({{ day }})"
                                    class="days-btn py-3 rounded-lg border text-center font-mono transition-colors
                                           {{ 'bg-accent border-accent text-dark-900' if default_days == day else 'bg-dark-700 border-dark-500 text-gray-400 hover:border-gray-500' }}"
                                    data-days="{{ day }}">{{ day }}</button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Cycle Length</label>
                        <div class="grid grid-cols-3 gap-2">
                            {% set default_length = profile.cycle_length_weeks if profile and profile.cycle_length_weeks else 6 %}
                            {% for weeks in [4, 6, 8] %}
                            <button type="button" onclick="selectCycleLength({{ weeks }})"
                                    class="length-btn py-3 rounded-lg border text-center transition-colors
                                           {{ 'bg-accent border-accent text-dark-900' if default_length == weeks else 'bg-dark-700 border-dark-500 text-gray-400 hover:border-gray-500' }}"
                                    data-weeks="{{ weeks }}">{{ weeks }} weeks</button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Start Date</label>
                        <input type="date" id="start-date" value="{{ next_monday.isoformat() }}" min="{{ today.isoformat() }}"
                               class="w-full bg-dark-700 border border-dark-500 rounded-lg px-4 py-3 text-gray-100 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent">
                        <p class="text-xs text-gray-500 mt-1">Cycles start on Monday</p>
                    </div>
                    
                    <!-- Show Rest Intervals Toggle -->
                    <div class="flex items-center justify-between py-3 border-t border-dark-600">
                        <div>
                            <p class="text-sm font-medium text-gray-300">Show Rest Intervals</p>
                            <p class="text-xs text-gray-500">Display rest times between sets during workouts</p>
                        </div>
                        <button type="button" id="show-rest-toggle" onclick="toggleShowRest()"
                                class="relative inline-flex h-6 w-11 items-center rounded-full bg-accent transition-colors">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                        </button>
                    </div>
                </div>
                
                <button onclick="goToStep(2)" class="w-full mt-6 py-3 bg-accent hover:bg-accent/90 text-dark-900 font-semibold rounded-xl transition-colors">Continue</button>
            </div>
            
            <!-- Step 2: Schedule -->
            <div id="step-2" class="step-content hidden">
                <h2 class="text-xl font-semibold text-gray-100 mb-2">Set Your Schedule</h2>
                <p class="text-gray-500 mb-6">Choose which days you'll train each week. <span id="step2-drag-hint">Drag to reorder.</span></p>
                
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-5">
                    <div id="schedule-grid" class="space-y-3"></div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="goToStep(1)" class="flex-1 py-3 border border-dark-600 text-gray-400 rounded-xl hover:bg-dark-800 transition-colors">Back</button>
                    <button onclick="goToStep(3)" class="flex-1 py-3 bg-accent hover:bg-accent/90 text-dark-900 font-semibold rounded-xl transition-colors">Continue</button>
                </div>
            </div>
            
            <!-- Step 3: Exercises -->
            <div id="step-3" class="step-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-100">Plan Exercises</h2>
                        <p class="text-gray-500 text-sm">Tap to swap, drag to reorder, × to remove</p>
                    </div>
                </div>
                
                <!-- Week Navigation Tabs -->
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-sm text-gray-400">Week:</span>
                        <div id="week-tabs" class="flex gap-1 flex-wrap">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Copy Week Actions -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="copyWeekTo('all')" class="px-3 py-1.5 text-xs bg-dark-700 border border-dark-600 rounded-lg text-gray-400 hover:text-accent hover:border-accent transition-colors">
                            Copy to All Weeks
                        </button>
                        <button onclick="copyWeekTo('odd')" class="px-3 py-1.5 text-xs bg-dark-700 border border-dark-600 rounded-lg text-gray-400 hover:text-accent hover:border-accent transition-colors">
                            Copy to Odd Weeks
                        </button>
                        <button onclick="copyWeekTo('even')" class="px-3 py-1.5 text-xs bg-dark-700 border border-dark-600 rounded-lg text-gray-400 hover:text-accent hover:border-accent transition-colors">
                            Copy to Even Weeks
                        </button>
                    </div>
                </div>
                
                <div id="exercises-review" class="space-y-4"></div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="goToStep(2)" class="flex-1 py-3 border border-dark-600 text-gray-400 rounded-xl hover:bg-dark-800 transition-colors">Back</button>
                    <button onclick="createCycle()" id="create-btn" class="flex-1 py-3 bg-accent hover:bg-accent/90 text-dark-900 font-semibold rounded-xl transition-colors">Create Cycle</button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Exercise Modal -->
<div id="exercise-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="closeModal()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-dark-800 rounded-t-2xl max-h-[85vh] flex flex-col">
        <!-- Fixed Header -->
        <div class="p-4 border-b border-dark-600 flex-shrink-0">
            <div class="flex items-center justify-between">
                <h3 id="modal-title" class="font-semibold text-gray-100">Select Exercise</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <p id="modal-subtitle" class="text-sm text-gray-500 mt-1"></p>
            <div class="mt-3 flex gap-2">
                <input type="text" id="exercise-search" placeholder="Search..." oninput="filterExercises()"
                       class="flex-1 bg-dark-700 border border-dark-500 rounded-lg px-3 py-2 text-sm text-gray-100 focus:outline-none focus:border-accent">
                <select id="muscle-filter" onchange="filterExercises()"
                        class="bg-dark-700 border border-dark-500 rounded-lg px-3 py-2 text-sm text-gray-100 focus:outline-none focus:border-accent">
                    <option value="">All</option>
                    <option value="chest">Chest</option>
                    <option value="back">Back</option>
                    <option value="shoulders">Shoulders</option>
                    <option value="biceps">Biceps</option>
                    <option value="triceps">Triceps</option>
                    <option value="quads">Quads</option>
                    <option value="hamstrings">Hamstrings</option>
                    <option value="glutes">Glutes</option>
                    <option value="calves">Calves</option>
                </select>
            </div>
        </div>
        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto pb-4">
            <div id="exercise-options" class="p-4 space-y-2 min-h-[200px]"></div>
            <div class="p-4 border-t border-dark-600">
            <button onclick="toggleAddForm()" id="add-new-btn" class="w-full py-3 border border-dashed border-gray-600 rounded-lg text-gray-400 hover:border-accent hover:text-accent transition-colors">+ Add New Exercise</button>
            <div id="add-form" class="hidden mt-4 space-y-3">
                <input type="text" id="new-name" placeholder="Exercise name" class="w-full bg-dark-700 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-accent">
                <div class="grid grid-cols-2 gap-2">
                    <select id="new-muscle" class="bg-dark-700 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-accent">
                        <option value="">Muscle group</option>
                        <option value="chest">Chest</option>
                        <option value="back">Back</option>
                        <option value="shoulders">Shoulders</option>
                        <option value="biceps">Biceps</option>
                        <option value="triceps">Triceps</option>
                        <option value="quads">Quads</option>
                        <option value="hamstrings">Hamstrings</option>
                        <option value="glutes">Glutes</option>
                        <option value="calves">Calves</option>
                    </select>
                    <select id="new-equipment" class="bg-dark-700 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-accent">
                        <option value="">Equipment</option>
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="cable">Cable</option>
                        <option value="machine">Machine</option>
                        <option value="bodyweight">Bodyweight</option>
                    </select>
                </div>
                <!-- AI Cue Generation -->
                <div class="bg-dark-700 rounded-lg p-3 space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-400">Form Cues</label>
                        <button type="button" onclick="generateCues()" id="generate-cues-btn"
                                class="text-xs px-2 py-1 bg-accent/20 text-accent rounded hover:bg-accent/30 transition-colors">
                            ✨ Generate with AI
                        </button>
                    </div>
                    <div id="cues-container" class="space-y-1">
                        <div class="flex gap-2">
                            <input type="text" class="cue-input flex-1 bg-dark-600 border border-dark-500 rounded px-2 py-1.5 text-sm text-gray-100" placeholder="Cue 1">
                            <button onclick="removeCueInput(this)" class="text-gray-500 hover:text-red-400">×</button>
                        </div>
                    </div>
                    <button type="button" onclick="addCueInput()" class="text-xs text-gray-500 hover:text-accent">+ Add cue</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleAddForm()" class="flex-1 py-2 border border-dark-600 rounded-lg text-gray-400">Cancel</button>
                    <button onclick="addNewExercise()" class="flex-1 py-2 bg-accent text-dark-900 rounded-lg font-medium">Add</button>
                </div>
            </div>
        </div>
        </div><!-- Close scrollable content -->
    </div>
</div>

<!-- Copy Confirmation Modal -->
<div id="copy-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="closeCopyModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-dark-800 rounded-xl w-[90%] max-w-md p-5">
        <h3 class="font-semibold text-gray-100 mb-2">Overwrite Existing Exercises?</h3>
        <p id="copy-modal-message" class="text-sm text-gray-400 mb-4">
            Some weeks already have exercises configured. Copying will replace them.
        </p>
        <div class="flex gap-3">
            <button onclick="closeCopyModal()" class="flex-1 py-2 border border-dark-600 text-gray-400 rounded-lg hover:bg-dark-700 transition-colors">Cancel</button>
            <button onclick="confirmCopyWeek()" class="flex-1 py-2 bg-accent text-dark-900 rounded-lg font-medium hover:bg-accent/90 transition-colors">Overwrite</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allExercises = [];
    const profilePreferredDays = {{ (profile.preferred_days | tojson) if profile and profile.preferred_days else '["monday", "wednesday", "friday"]' | safe }};
    const dayNameToIndex = {'monday': 0, 'tuesday': 1, 'wednesday': 2, 'thursday': 3, 'friday': 4, 'saturday': 5, 'sunday': 6};
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const preferredDayIndices = profilePreferredDays.map(d => dayNameToIndex[d.toLowerCase()]).filter(d => d !== undefined);
    const REST_OPTIONS = [15, 30, 60, 120, 180];
    
    let cycleConfig = {
        name: '',
        splitType: '{{ profile.split_type if profile and profile.split_type else "ppl" }}'.replace('ppl_3day', 'ppl').replace('ppl_6day', 'ppl'),
        daysPerWeek: {{ profile.days_per_week if profile and profile.days_per_week else 3 }},
        lengthWeeks: {{ profile.cycle_length_weeks if profile and profile.cycle_length_weeks else 6 }},
        startDate: '{{ next_monday.isoformat() }}',
        showRestIntervals: true,
        schedule: [],
        // Multi-week exercise structure: exercises[weekNumber][workoutIndex] = array of exercises
        weeklyExercises: {},
        // Rotation tracking
        rotationWeeks: 1,
        selectedScheduleWeek: '1'
    };
    
    let currentWeek = 1;
    let modalMode = 'swap';
    let swapTarget = null;
    let addTarget = null;
    let pendingCopyAction = null;
    
    // Drag state for schedule
    let draggedScheduleIndex = null;
    
    // Drag state for exercises
    let draggedExercise = { wIdx: null, eIdx: null };
    
    function formatRestTime(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return secs > 0 ? `${mins}:${String(secs).padStart(2, '0')}` : `${mins}:00`;
    }
    
    function toggleShowRest() {
        cycleConfig.showRestIntervals = !cycleConfig.showRestIntervals;
        const toggle = document.getElementById('show-rest-toggle');
        const knob = toggle.querySelector('span');
        if (cycleConfig.showRestIntervals) {
            toggle.classList.add('bg-accent');
            toggle.classList.remove('bg-dark-600');
            knob.classList.add('translate-x-6');
            knob.classList.remove('translate-x-1');
        } else {
            toggle.classList.remove('bg-accent');
            toggle.classList.add('bg-dark-600');
            knob.classList.remove('translate-x-6');
            knob.classList.add('translate-x-1');
        }
    }
    
    function isCustomSplit() {
        return cycleConfig.splitType === 'custom';
    }
    
    // Cached schedule data from API
    let cachedScheduleData = null;
    
    async function fetchWorkoutStructure() {
        // Fetch from API to get proper rotation logic
        try {
            const response = await fetch(`/api/schedule/preview?split=${cycleConfig.splitType}&days=${cycleConfig.daysPerWeek}`);
            const data = await response.json();
            cachedScheduleData = data;
            return data;
        } catch (err) {
            console.error('Failed to fetch schedule preview:', err);
            return null;
        }
    }
    
    function getWorkoutStructureFromCache() {
        // Fallback for synchronous calls - returns flat structure from week 1
        if (!cachedScheduleData || !cachedScheduleData.weeks || !cachedScheduleData.weeks[0]) {
            // Return simple fallback
            const days = cycleConfig.daysPerWeek;
            return Array.from({length: days}, (_, i) => ({
                name: `Day ${i + 1}`,
                heavyFocus: [],
                muscles: ['chest', 'back', 'shoulders', 'quads', 'hamstrings', 'biceps', 'triceps', 'glutes', 'calves'],
                week_pattern: null
            }));
        }
        
        // Build flat structure from all weeks for rotating splits
        const structure = [];
        const rotationWeeks = cachedScheduleData.rotation_weeks || 1;
        
        cachedScheduleData.weeks.forEach((week, weekIdx) => {
            week.days.forEach((day, dayIdx) => {
                // For rotation splits, we need separate slots for each week pattern
                const weekPattern = rotationWeeks > 1 ? String(week.week_number) : null;
                
                // Collect all muscle groups from focuses
                const muscles = new Set();
                const heavyFocus = [];
                day.focuses.forEach(focus => {
                    (focus.muscle_groups || []).forEach(m => muscles.add(m));
                    if (focus.is_heavy) heavyFocus.push(focus.name.toLowerCase());
                });
                
                structure.push({
                    name: day.name || day.display_name,
                    heavyFocus: heavyFocus,
                    muscles: Array.from(muscles),
                    week_pattern: weekPattern,
                    day_number: day.day_number,
                    focuses: day.focuses
                });
            });
        });
        
        return structure;
    }
    
    // Legacy function for compatibility
    function getWorkoutStructure() {
        return getWorkoutStructureFromCache();
    }
    
    function getDefaultDayAssignments(numWorkouts) {
        if (preferredDayIndices.length >= numWorkouts) return preferredDayIndices.slice(0, numWorkouts);
        const result = [...preferredDayIndices];
        for (let d = 0; d < 7 && result.length < numWorkouts; d++) {
            if (!result.includes(d)) result.push(d);
        }
        return result.slice(0, numWorkouts).sort((a, b) => a - b);
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/exercises');
            allExercises = await response.json();
        } catch (err) { console.error('Failed to load exercises:', err); }
        
        document.getElementById('cycle-name').addEventListener('change', e => cycleConfig.name = e.target.value);
        document.getElementById('start-date').addEventListener('change', e => cycleConfig.startDate = e.target.value);
        updateScheduleGrid();
    });
    
    function selectSplit(split) {
        cycleConfig.splitType = split;
        document.querySelectorAll('.split-btn').forEach(btn => {
            btn.classList.toggle('bg-accent/20', btn.dataset.split === split);
            btn.classList.toggle('border-accent', btn.dataset.split === split);
            btn.classList.toggle('text-accent', btn.dataset.split === split);
            btn.classList.toggle('bg-dark-700', btn.dataset.split !== split);
            btn.classList.toggle('border-dark-500', btn.dataset.split !== split);
            btn.classList.toggle('text-gray-400', btn.dataset.split !== split);
        });
        updateScheduleGrid();
    }
    
    function selectDaysPerWeek(days) {
        cycleConfig.daysPerWeek = days;
        document.querySelectorAll('.days-btn').forEach(btn => {
            const match = parseInt(btn.dataset.days) === days;
            btn.classList.toggle('bg-accent', match);
            btn.classList.toggle('border-accent', match);
            btn.classList.toggle('text-dark-900', match);
            btn.classList.toggle('bg-dark-700', !match);
            btn.classList.toggle('border-dark-500', !match);
            btn.classList.toggle('text-gray-400', !match);
        });
        updateScheduleGrid();
    }
    
    function selectCycleLength(weeks) {
        cycleConfig.lengthWeeks = weeks;
        document.querySelectorAll('.length-btn').forEach(btn => {
            const match = parseInt(btn.dataset.weeks) === weeks;
            btn.classList.toggle('bg-accent', match);
            btn.classList.toggle('border-accent', match);
            btn.classList.toggle('text-dark-900', match);
            btn.classList.toggle('bg-dark-700', !match);
            btn.classList.toggle('border-dark-500', !match);
            btn.classList.toggle('text-gray-400', !match);
        });
    }
    
    async function updateScheduleGrid() {
        const grid = document.getElementById('schedule-grid');
        
        // Show loading state
        grid.innerHTML = '<div class="text-center text-gray-500 py-4">Loading schedule...</div>';
        
        // Fetch structure from API
        const scheduleData = await fetchWorkoutStructure();
        
        if (!scheduleData) {
            grid.innerHTML = '<div class="text-center text-red-400 py-4">Failed to load schedule</div>';
            return;
        }
        
        // Store rotation info
        cycleConfig.rotationWeeks = scheduleData.rotation_weeks || 1;
        
        const structure = getWorkoutStructureFromCache();
        const defaultDays = getDefaultDayAssignments(cycleConfig.daysPerWeek);
        
        // For rotating splits, we have multiple slots per week pattern
        // Group them by week_pattern for display
        if (cycleConfig.rotationWeeks > 1) {
            // Create schedule entries with week_pattern
            cycleConfig.schedule = [];
            let dayAssignmentIdx = 0;
            
            scheduleData.weeks.forEach((week, weekIdx) => {
                week.days.forEach((day, dayIdx) => {
                    const muscles = new Set();
                    const heavyFocus = [];
                    day.focuses.forEach(focus => {
                        (focus.muscle_groups || []).forEach(m => muscles.add(m));
                        if (focus.is_heavy) heavyFocus.push(focus.name.toLowerCase());
                    });
                    
                    cycleConfig.schedule.push({
                        workoutIndex: cycleConfig.schedule.length,
                        dayOfWeek: defaultDays[dayIdx % defaultDays.length],
                        workoutName: day.name || day.display_name,
                        heavyFocus: heavyFocus,
                        muscles: Array.from(muscles),
                        isCustom: cycleConfig.splitType === 'custom',
                        week_pattern: String(week.week_number),
                        focuses: day.focuses
                    });
                });
            });
        } else {
            // Non-rotating: simple 1:1 mapping
            cycleConfig.schedule = structure.map((workout, i) => ({
                workoutIndex: i,
                dayOfWeek: defaultDays[i % defaultDays.length],
                workoutName: workout.name,
                heavyFocus: workout.heavyFocus,
                muscles: workout.muscles,
                isCustom: workout.isCustom || cycleConfig.splitType === 'custom',
                week_pattern: null,
                focuses: workout.focuses
            }));
        }
        
        // Reset weekly exercises
        cycleConfig.weeklyExercises = {};
        
        renderScheduleGrid();
    }
    
    function renderScheduleGrid() {
        const grid = document.getElementById('schedule-grid');
        const isCustom = isCustomSplit();
        
        // Update step 2 hint text
        document.getElementById('step2-drag-hint').textContent = isCustom ? 'Name your workouts and assign days.' : 'Drag to reorder.';
        
        // Check if this is a rotating split
        const rotationWeeks = cycleConfig.rotationWeeks || 1;
        
        if (rotationWeeks > 1) {
            // Group schedule by week_pattern
            const weekGroups = {};
            cycleConfig.schedule.forEach((workout, idx) => {
                const week = workout.week_pattern || '1';
                if (!weekGroups[week]) weekGroups[week] = [];
                weekGroups[week].push({ ...workout, originalIdx: idx });
            });
            
            const weekNumbers = Object.keys(weekGroups).sort((a, b) => parseInt(a) - parseInt(b));
            
            // Initialize selected week if not set
            if (!cycleConfig.selectedScheduleWeek) {
                cycleConfig.selectedScheduleWeek = weekNumbers[0] || '1';
            }
            
            // Build week tabs
            let html = `
                <div class="flex gap-2 mb-4 border-b border-dark-600 pb-3">
                    ${weekNumbers.map(week => `
                        <button onclick="selectScheduleWeek('${week}')"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors
                                       ${cycleConfig.selectedScheduleWeek === week 
                                         ? 'bg-accent text-dark-900' 
                                         : 'bg-dark-700 text-gray-400 hover:text-gray-200'}">
                            Week ${week}
                        </button>
                    `).join('')}
                </div>
                <p class="text-xs text-gray-500 mb-3">${rotationWeeks}-week rotation pattern. Configure each week's schedule.</p>
            `;
            
            // Show workouts for selected week only
            const selectedWeekWorkouts = weekGroups[cycleConfig.selectedScheduleWeek] || [];
            const sortedSchedule = [...selectedWeekWorkouts].sort((a, b) => a.dayOfWeek - b.dayOfWeek);
            
            html += `<div class="space-y-3">`;
            html += sortedSchedule.map((workout) => {
                const originalIdx = workout.originalIdx;
                return `
                <div class="schedule-tile flex items-center gap-3 p-3 bg-dark-700 rounded-lg border border-transparent transition-all cursor-grab active:cursor-grabbing"
                     draggable="true"
                     data-schedule-idx="${originalIdx}"
                     ondragstart="onScheduleDragStart(event, ${originalIdx})"
                     ondragend="onScheduleDragEnd(event)"
                     ondragover="onScheduleDragOver(event)"
                     ondragleave="onScheduleDragLeave(event)"
                     ondrop="onScheduleDrop(event, ${originalIdx})">
                    <div class="text-gray-600 drag-handle">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-100">${workout.workoutName}</p>
                        <p class="text-xs text-gray-500">${(workout.muscles || []).slice(0, 3).join(', ')}</p>
                    </div>
                    <select onchange="updateWorkoutDay(${originalIdx}, parseInt(this.value))"
                            class="bg-dark-600 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 text-sm focus:outline-none focus:border-accent">
                        ${dayNames.map((name, d) => `<option value="${d}" ${workout.dayOfWeek === d ? 'selected' : ''}>${name}</option>`).join('')}
                    </select>
                </div>
                `;
            }).join('');
            html += `</div>`;
            
            grid.innerHTML = html;
        } else {
            // Non-rotating split: original behavior
            const sortedSchedule = [...cycleConfig.schedule].sort((a, b) => a.dayOfWeek - b.dayOfWeek);
            
            grid.innerHTML = sortedSchedule.map((workout, displayIdx) => {
                const originalIdx = cycleConfig.schedule.indexOf(workout);
                
                if (isCustom) {
                    // Custom split: editable name field
                    return `
                    <div class="schedule-tile flex items-center gap-3 p-3 bg-dark-700 rounded-lg border border-transparent transition-all"
                         data-schedule-idx="${originalIdx}">
                        <div class="flex-1 flex items-center gap-3">
                            <input type="text" 
                                   value="${workout.workoutName}"
                                   onchange="updateWorkoutName(${originalIdx}, this.value)"
                                   placeholder="Workout name"
                                   class="flex-1 bg-dark-600 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-accent">
                        </div>
                        <select onchange="updateWorkoutDay(${originalIdx}, parseInt(this.value))"
                                class="bg-dark-600 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 text-sm focus:outline-none focus:border-accent">
                            ${dayNames.map((name, d) => `<option value="${d}" ${workout.dayOfWeek === d ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>
                `;
                } else {
                    // Predefined split: draggable with fixed names
                    return `
                    <div class="schedule-tile flex items-center gap-3 p-3 bg-dark-700 rounded-lg border border-transparent transition-all cursor-grab active:cursor-grabbing"
                         draggable="true"
                         data-schedule-idx="${originalIdx}"
                         ondragstart="onScheduleDragStart(event, ${originalIdx})"
                         ondragend="onScheduleDragEnd(event)"
                         ondragover="onScheduleDragOver(event)"
                         ondragleave="onScheduleDragLeave(event)"
                         ondrop="onScheduleDrop(event, ${originalIdx})">
                        <div class="text-gray-600 drag-handle">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-100">${workout.workoutName}</p>
                            <p class="text-xs text-gray-500">${(workout.muscles || []).slice(0, 3).join(', ')}</p>
                        </div>
                        <select onchange="updateWorkoutDay(${originalIdx}, parseInt(this.value))"
                                class="bg-dark-600 border border-dark-500 rounded-lg px-3 py-2 text-gray-100 text-sm focus:outline-none focus:border-accent">
                            ${dayNames.map((name, d) => `<option value="${d}" ${workout.dayOfWeek === d ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>
                `};
            }).join('');
        }
    }
    
    function selectScheduleWeek(week) {
        cycleConfig.selectedScheduleWeek = week;
        renderScheduleGrid();
    }
    
    function updateWorkoutName(scheduleIdx, newName) {
        cycleConfig.schedule[scheduleIdx].workoutName = newName || `Day ${scheduleIdx + 1}`;
    }
    
    function updateWorkoutDay(scheduleIdx, newDay) {
        cycleConfig.schedule[scheduleIdx].dayOfWeek = newDay;
        renderScheduleGrid(); // Re-render to re-sort
    }
    
    // Schedule drag handlers
    function onScheduleDragStart(event, idx) {
        draggedScheduleIndex = idx;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
    }
    
    function onScheduleDragEnd(event) {
        event.target.classList.remove('dragging');
        document.querySelectorAll('.schedule-tile').forEach(el => el.classList.remove('drag-over'));
        draggedScheduleIndex = null;
    }
    
    function onScheduleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        event.currentTarget.classList.add('drag-over');
    }
    
    function onScheduleDragLeave(event) {
        event.currentTarget.classList.remove('drag-over');
    }
    
    function onScheduleDrop(event, targetIdx) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');
        
        if (draggedScheduleIndex === null || draggedScheduleIndex === targetIdx) return;
        
        // Swap the days of week between the two workouts
        const tempDay = cycleConfig.schedule[draggedScheduleIndex].dayOfWeek;
        cycleConfig.schedule[draggedScheduleIndex].dayOfWeek = cycleConfig.schedule[targetIdx].dayOfWeek;
        cycleConfig.schedule[targetIdx].dayOfWeek = tempDay;
        
        renderScheduleGrid();
    }
    
    function goToStep(step) {
        for (let i = 1; i <= 3; i++) {
            const ind = document.getElementById(`step-${i}-indicator`);
            const circle = ind.querySelector('span:first-child');
            const text = ind.querySelector('span:last-child');
            circle.className = 'flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ' + 
                (i < step ? 'bg-success text-white' : i === step ? 'bg-accent text-dark-900' : 'bg-dark-600 text-gray-500');
            text.className = 'text-sm ' + (i <= step ? 'text-gray-300' : 'text-gray-500');
        }
        document.getElementById('progress-line-1').style.width = step > 1 ? '100%' : '0%';
        document.getElementById('progress-line-2').style.width = step > 2 ? '100%' : '0%';
        for (let i = 1; i <= 3; i++) document.getElementById(`step-${i}`).classList.toggle('hidden', i !== step);
        if (step === 3) {
            currentWeek = 1;
            renderWeekTabs();
            loadExercisesForWeek();
        }
    }
    
    // ========================================
    // WEEK NAVIGATION
    // ========================================
    
    function renderWeekTabs() {
        const container = document.getElementById('week-tabs');
        let html = '';
        for (let w = 1; w <= cycleConfig.lengthWeeks; w++) {
            const isActive = w === currentWeek;
            const hasExercises = cycleConfig.weeklyExercises[w] && 
                Object.values(cycleConfig.weeklyExercises[w]).some(arr => arr && arr.length > 0);
            html += `
                <button onclick="switchToWeek(${w})" 
                        class="week-tab px-3 py-1.5 text-sm rounded-lg border ${isActive ? 'active' : 'border-dark-600 text-gray-500'}">
                    ${w}${hasExercises && !isActive ? ' •' : ''}
                </button>
            `;
        }
        container.innerHTML = html;
    }
    
    function switchToWeek(weekNum) {
        currentWeek = weekNum;
        renderWeekTabs();
        loadExercisesForWeek();
    }
    
    // ========================================
    // COPY WEEK FUNCTIONALITY
    // ========================================
    
    function copyWeekTo(target) {
        // Check if source week has exercises
        const sourceExercises = cycleConfig.weeklyExercises[currentWeek];
        if (!sourceExercises || Object.values(sourceExercises).every(arr => !arr || arr.length === 0)) {
            alert('Current week has no exercises to copy.');
            return;
        }
        
        // Determine target weeks
        let targetWeeks = [];
        if (target === 'all') {
            for (let w = 1; w <= cycleConfig.lengthWeeks; w++) {
                if (w !== currentWeek) targetWeeks.push(w);
            }
        } else if (target === 'odd') {
            for (let w = 1; w <= cycleConfig.lengthWeeks; w += 2) {
                if (w !== currentWeek) targetWeeks.push(w);
            }
        } else if (target === 'even') {
            for (let w = 2; w <= cycleConfig.lengthWeeks; w += 2) {
                if (w !== currentWeek) targetWeeks.push(w);
            }
        }
        
        if (targetWeeks.length === 0) {
            alert('No weeks to copy to.');
            return;
        }
        
        // Check if any target weeks have exercises
        const weeksWithExercises = targetWeeks.filter(w => 
            cycleConfig.weeklyExercises[w] && 
            Object.values(cycleConfig.weeklyExercises[w]).some(arr => arr && arr.length > 0)
        );
        
        if (weeksWithExercises.length > 0) {
            // Show confirmation modal
            pendingCopyAction = { sourceWeek: currentWeek, targetWeeks };
            const message = `Week${weeksWithExercises.length > 1 ? 's' : ''} ${weeksWithExercises.join(', ')} already ha${weeksWithExercises.length > 1 ? 've' : 's'} exercises. Copying from Week ${currentWeek} will replace them.`;
            document.getElementById('copy-modal-message').textContent = message;
            document.getElementById('copy-modal').classList.remove('hidden');
        } else {
            // No confirmation needed, just copy
            executeCopyWeek(currentWeek, targetWeeks);
        }
    }
    
    function closeCopyModal() {
        document.getElementById('copy-modal').classList.add('hidden');
        pendingCopyAction = null;
    }
    
    function confirmCopyWeek() {
        if (pendingCopyAction) {
            executeCopyWeek(pendingCopyAction.sourceWeek, pendingCopyAction.targetWeeks);
        }
        closeCopyModal();
    }
    
    function executeCopyWeek(sourceWeek, targetWeeks) {
        const sourceExercises = cycleConfig.weeklyExercises[sourceWeek];
        
        for (const targetWeek of targetWeeks) {
            // Deep copy the exercises
            cycleConfig.weeklyExercises[targetWeek] = {};
            for (const workoutIdx in sourceExercises) {
                cycleConfig.weeklyExercises[targetWeek][workoutIdx] = 
                    sourceExercises[workoutIdx].map(ex => ({...ex}));
            }
        }
        
        renderWeekTabs();
        alert(`Copied Week ${sourceWeek} to Week${targetWeeks.length > 1 ? 's' : ''} ${targetWeeks.join(', ')}`);
    }
    
    // ========================================
    // EXERCISE LOADING & RENDERING
    // ========================================
    
    // Map focus categories to muscle groups
    const FOCUS_TO_MUSCLES = {
        'push': ['chest', 'shoulders', 'triceps'],
        'pull': ['back', 'biceps', 'rear_delts'],
        'legs': ['quads', 'hamstrings', 'glutes', 'calves'],
        'upper': ['chest', 'back', 'shoulders', 'biceps', 'triceps'],
        'lower': ['quads', 'hamstrings', 'glutes', 'calves'],
        'compound': ['chest', 'back', 'shoulders', 'quads', 'hamstrings', 'glutes']
    };
    
    function isMuscleInHeavyFocus(muscleGroup, heavyFocus) {
        if (!heavyFocus || heavyFocus.length === 0) return false;
        const muscleGroupLower = muscleGroup.toLowerCase();
        for (const focus of heavyFocus) {
            const muscles = FOCUS_TO_MUSCLES[focus.toLowerCase()] || [];
            if (muscles.includes(muscleGroupLower)) return true;
        }
        return false;
    }
    
    function getDefaultExercisesForWorkout(workout) {
        // For custom splits, return empty array (blank slate)
        if (workout.isCustom || isCustomSplit()) {
            return [];
        }
        
        const exercises = [];
        for (const muscle of workout.muscles || []) {
            const muscleExs = allExercises.filter(e => e.muscle_group === muscle && !exercises.find(ex => ex.id === e.id));
            const compound = muscleExs.find(e => e.is_compound);
            if (compound && exercises.length < 8) {
                const isHeavy = isMuscleInHeavyFocus(muscle, workout.heavyFocus);
                exercises.push({
                    ...compound, 
                    is_heavy: isHeavy,
                    sets_heavy: 4,
                    sets_light: 3,
                    rep_range_heavy: '6-8',
                    rep_range_light: '10-12',
                    rest_heavy: 180,
                    rest_light: 60
                });
            }
        }
        for (const muscle of workout.muscles || []) {
            const muscleExs = allExercises.filter(e => e.muscle_group === muscle && !exercises.find(ex => ex.id === e.id));
            const isolation = muscleExs.find(e => !e.is_compound);
            if (isolation && exercises.length < 8) {
                const isHeavy = isMuscleInHeavyFocus(muscle, workout.heavyFocus);
                exercises.push({
                    ...isolation, 
                    is_heavy: isHeavy,
                    sets_heavy: 3,
                    sets_light: 3,
                    rep_range_heavy: '8-10',
                    rep_range_light: '10-12',
                    rest_heavy: 120,
                    rest_light: 60
                });
            }
        }
        return exercises.slice(0, 8);
    }
    
    function loadExercisesForWeek() {
        const container = document.getElementById('exercises-review');
        const structure = getWorkoutStructure();
        const isCustom = isCustomSplit();
        const rotationWeeks = cycleConfig.rotationWeeks || 1;
        
        // Initialize this week's exercises if not exists
        if (!cycleConfig.weeklyExercises[currentWeek]) {
            cycleConfig.weeklyExercises[currentWeek] = {};
        }
        
        // For rotating splits, determine which week_pattern applies to this calendar week
        // Week 1 -> pattern "1", Week 2 -> pattern "2", Week 3 -> pattern "1" (for 2-week rotation), etc.
        let relevantWeekPattern = null;
        if (rotationWeeks > 1) {
            const patternIndex = ((currentWeek - 1) % rotationWeeks) + 1;
            relevantWeekPattern = String(patternIndex);
        }
        
        // Filter and sort schedule by day of week for display
        let scheduleToShow = cycleConfig.schedule
            .map((s, idx) => ({ ...s, originalIdx: idx }));
        
        // For rotating splits, filter to only show workouts for this week's pattern
        if (relevantWeekPattern !== null) {
            scheduleToShow = scheduleToShow.filter(s => s.week_pattern === relevantWeekPattern);
        }
        
        scheduleToShow = scheduleToShow.sort((a, b) => a.dayOfWeek - b.dayOfWeek);
        
        // Show info about rotation if applicable
        let rotationInfo = '';
        if (rotationWeeks > 1) {
            rotationInfo = `<p class="text-xs text-accent mb-3">Week ${currentWeek} uses pattern "${relevantWeekPattern}" (${rotationWeeks}-week rotation)</p>`;
        }
        
        container.innerHTML = rotationInfo + scheduleToShow.map((scheduleItem) => {
            const wIdx = scheduleItem.originalIdx;
            const workout = structure[scheduleItem.workoutIndex] || { name: scheduleItem.workoutName, muscles: scheduleItem.muscles };
            
            // Initialize exercises for this workout if not exists
            if (!cycleConfig.weeklyExercises[currentWeek][wIdx]) {
                cycleConfig.weeklyExercises[currentWeek][wIdx] = getDefaultExercisesForWorkout({
                    ...workout,
                    heavyFocus: scheduleItem.heavyFocus,
                    isCustom: scheduleItem.isCustom
                });
            }
            const exs = cycleConfig.weeklyExercises[currentWeek][wIdx];
            
            return `
                <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden" data-workout-idx="${wIdx}">
                    <div class="px-4 py-3 bg-dark-700 border-b border-dark-600 flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-100">${scheduleItem.workoutName}</h4>
                            <p class="text-xs text-gray-500">${dayNames[scheduleItem.dayOfWeek]}</p>
                        </div>
                        <button onclick="openModal('add', ${wIdx})" class="px-3 py-1 text-xs bg-dark-600 text-accent rounded-lg hover:bg-dark-500">+ Add</button>
                    </div>
                    <div class="p-3 space-y-2 exercise-list" data-workout-idx="${wIdx}">
                        ${exs.length === 0 ? `
                            <div class="text-center py-6 text-gray-500">
                                <p class="text-sm">No exercises yet</p>
                                <p class="text-xs mt-1">Click "+ Add" to add exercises</p>
                            </div>
                        ` : exs.map((ex, eIdx) => {
                            // For custom splits, no heavy/light distinction
                            const showHeavyLight = !isCustom && !scheduleItem.isCustom;
                            const restTime = showHeavyLight ? (ex.is_heavy ? (ex.rest_heavy || 180) : (ex.rest_light || 60)) : (ex.rest_light || 60);
                            const sets = showHeavyLight ? (ex.is_heavy ? (ex.sets_heavy || 4) : (ex.sets_light || 3)) : (ex.sets || ex.sets_light || 3);
                            const reps = showHeavyLight ? (ex.is_heavy ? (ex.rep_range_heavy || '6-8') : (ex.rep_range_light || '10-12')) : (ex.rep_range || ex.rep_range_light || '10-12');
                            
                            return `
                            <div class="exercise-tile p-3 bg-dark-700 rounded-lg group border border-transparent transition-all"
                                 draggable="true"
                                 data-workout-idx="${wIdx}"
                                 data-exercise-idx="${eIdx}"
                                 ondragstart="onExerciseDragStart(event, ${wIdx}, ${eIdx})"
                                 ondragend="onExerciseDragEnd(event)"
                                 ondragover="onExerciseDragOver(event)"
                                 ondragleave="onExerciseDragLeave(event)"
                                 ondrop="onExerciseDrop(event, ${wIdx}, ${eIdx})">
                                <div class="flex items-center gap-2">
                                    <div class="text-gray-600 cursor-grab active:cursor-grabbing drag-handle">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                        </svg>
                                    </div>
                                    <button onclick="openModal('swap', ${wIdx}, ${eIdx})" class="flex-1 text-left hover:bg-dark-600 rounded p-1 -m-1">
                                        <p class="text-gray-100 text-sm">${ex.name}</p>
                                        <p class="text-xs text-gray-500 capitalize">${ex.muscle_group} · ${ex.equipment || 'bodyweight'}</p>
                                    </button>
                                    <button onclick="removeExercise(${wIdx}, ${eIdx})" class="p-2 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>
                                <!-- Sets/Reps/Rest Controls -->
                                <div class="flex items-center gap-2 mt-2 pt-2 border-t border-dark-600">
                                    <div class="flex items-center gap-1">
                                        <label class="text-xs text-gray-500">Sets:</label>
                                        <input type="number" min="1" max="10" value="${sets}"
                                               onchange="updateExerciseSets(${wIdx}, ${eIdx}, this.value)"
                                               class="w-12 bg-dark-600 border border-dark-500 rounded px-2 py-1 text-center text-gray-100 text-sm font-mono focus:outline-none focus:border-accent">
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <label class="text-xs text-gray-500">Reps:</label>
                                        <input type="text" value="${reps}" placeholder="8-12"
                                               onchange="updateExerciseReps(${wIdx}, ${eIdx}, this.value)"
                                               class="w-16 bg-dark-600 border border-dark-500 rounded px-2 py-1 text-center text-gray-100 text-sm font-mono focus:outline-none focus:border-accent">
                                    </div>
                                    ${cycleConfig.showRestIntervals ? `
                                    <div class="flex items-center gap-1 rest-control" data-widx="${wIdx}" data-eidx="${eIdx}">
                                        <label class="text-xs text-gray-500">Rest:</label>
                                        <select onchange="updateExerciseRest(${wIdx}, ${eIdx}, this.value)"
                                                class="rest-select bg-dark-600 border border-dark-500 rounded px-1 py-1 text-gray-100 text-xs focus:outline-none focus:border-accent">
                                            <option value="15" ${restTime === 15 ? 'selected' : ''}>0:15</option>
                                            <option value="30" ${restTime === 30 ? 'selected' : ''}>0:30</option>
                                            <option value="60" ${restTime === 60 ? 'selected' : ''}>1:00</option>
                                            <option value="120" ${restTime === 120 ? 'selected' : ''}>2:00</option>
                                            <option value="180" ${restTime === 180 ? 'selected' : ''}>3:00</option>
                                            <option value="custom" ${![15,30,60,120,180].includes(restTime) ? 'selected' : ''}>Other</option>
                                        </select>
                                        <input type="number" min="5" max="600" step="5" value="${restTime}"
                                               onchange="updateExerciseRestCustom(${wIdx}, ${eIdx}, this.value)"
                                               class="rest-custom w-12 bg-dark-600 border border-dark-500 rounded px-1 py-1 text-center text-gray-100 text-xs font-mono focus:outline-none focus:border-accent ${[15,30,60,120,180].includes(restTime) ? 'hidden' : ''}">
                                        <span class="rest-custom-label text-xs text-gray-500 ${[15,30,60,120,180].includes(restTime) ? 'hidden' : ''}">s</span>
                                    </div>
                                    ` : ''}
                                    ${showHeavyLight ? `<span class="ml-auto text-xs ${ex.is_heavy ? 'text-accent' : 'text-gray-500'}">${ex.is_heavy ? 'Heavy' : 'Light'}</span>` : ''}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Exercise drag handlers
    function onExerciseDragStart(event, wIdx, eIdx) {
        draggedExercise = { wIdx, eIdx };
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
    }
    
    function onExerciseDragEnd(event) {
        event.target.classList.remove('dragging');
        document.querySelectorAll('.exercise-tile').forEach(el => el.classList.remove('drag-over'));
        draggedExercise = { wIdx: null, eIdx: null };
    }
    
    function onExerciseDragOver(event) {
        event.preventDefault();
        const tile = event.target.closest('.exercise-tile');
        if (tile) {
            const targetWIdx = parseInt(tile.dataset.workoutIdx);
            // Only allow drag within same workout
            if (draggedExercise.wIdx === targetWIdx) {
                event.dataTransfer.dropEffect = 'move';
                tile.classList.add('drag-over');
            }
        }
    }
    
    function onExerciseDragLeave(event) {
        const tile = event.target.closest('.exercise-tile');
        if (tile) tile.classList.remove('drag-over');
    }
    
    function onExerciseDrop(event, targetWIdx, targetEIdx) {
        event.preventDefault();
        const tile = event.target.closest('.exercise-tile');
        if (tile) tile.classList.remove('drag-over');
        
        const { wIdx, eIdx } = draggedExercise;
        
        // Only allow reorder within same workout
        if (wIdx === null || wIdx !== targetWIdx || eIdx === targetEIdx) return;
        
        // Reorder exercises
        const exercises = cycleConfig.weeklyExercises[currentWeek][wIdx];
        const [moved] = exercises.splice(eIdx, 1);
        exercises.splice(targetEIdx, 0, moved);
        
        loadExercisesForWeek();
    }
    
    function openModal(mode, wIdx, eIdx = null) {
        modalMode = mode;
        if (mode === 'swap') {
            swapTarget = { wIdx, eIdx };
            const ex = cycleConfig.weeklyExercises[currentWeek][wIdx][eIdx];
            document.getElementById('modal-title').textContent = 'Swap Exercise';
            document.getElementById('modal-subtitle').textContent = `Replace ${ex.name}`;
            document.getElementById('muscle-filter').value = ex.muscle_group;
        } else {
            addTarget = { wIdx };
            document.getElementById('modal-title').textContent = 'Add Exercise';
            document.getElementById('modal-subtitle').textContent = '';
            document.getElementById('muscle-filter').value = '';
        }
        document.getElementById('exercise-search').value = '';
        filterExercises();
        document.getElementById('exercise-modal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('exercise-modal').classList.add('hidden');
        document.getElementById('add-form').classList.add('hidden');
        document.getElementById('add-new-btn').classList.remove('hidden');
        swapTarget = addTarget = null;
    }
    
    function updateExerciseSets(wIdx, eIdx, value) {
        const ex = cycleConfig.weeklyExercises[currentWeek][wIdx][eIdx];
        const sets = parseInt(value) || 3;
        // For custom splits, just set a single 'sets' value
        if (isCustomSplit()) {
            ex.sets = sets;
            ex.sets_light = sets;
            ex.sets_heavy = sets;
        } else if (ex.is_heavy) {
            ex.sets_heavy = sets;
        } else {
            ex.sets_light = sets;
        }
    }
    
    function updateExerciseReps(wIdx, eIdx, value) {
        const ex = cycleConfig.weeklyExercises[currentWeek][wIdx][eIdx];
        const reps = value.trim() || '8-12';
        // For custom splits, just set a single 'rep_range' value
        if (isCustomSplit()) {
            ex.rep_range = reps;
            ex.rep_range_light = reps;
            ex.rep_range_heavy = reps;
        } else if (ex.is_heavy) {
            ex.rep_range_heavy = reps;
        } else {
            ex.rep_range_light = reps;
        }
    }
    
    function updateExerciseRest(wIdx, eIdx, value) {
        const container = document.querySelector(`.rest-control[data-widx="${wIdx}"][data-eidx="${eIdx}"]`);
        const customInput = container?.querySelector('.rest-custom');
        const customLabel = container?.querySelector('.rest-custom-label');
        
        if (value === 'custom') {
            // Show custom input
            customInput?.classList.remove('hidden');
            customLabel?.classList.remove('hidden');
            customInput?.focus();
        } else {
            // Hide custom input and set the value
            customInput?.classList.add('hidden');
            customLabel?.classList.add('hidden');
            
            const ex = cycleConfig.weeklyExercises[currentWeek][wIdx][eIdx];
            const seconds = parseInt(value) || 60;
            ex.rest_heavy = seconds;
            ex.rest_light = seconds;
        }
    }
    
    function updateExerciseRestCustom(wIdx, eIdx, value) {
        const ex = cycleConfig.weeklyExercises[currentWeek][wIdx][eIdx];
        const seconds = parseInt(value) || 60;
        ex.rest_heavy = seconds;
        ex.rest_light = seconds;
    }
    
    function filterExercises() {
        const search = document.getElementById('exercise-search').value.toLowerCase();
        const muscle = document.getElementById('muscle-filter').value;
        const filtered = allExercises.filter(e => (!search || e.name.toLowerCase().includes(search)) && (!muscle || e.muscle_group === muscle));
        
        document.getElementById('exercise-options').innerHTML = filtered.map(ex => `
            <button onclick="selectExerciseById('${ex.id}')"
                    class="w-full flex items-center justify-between p-3 bg-dark-700 rounded-lg hover:bg-dark-600 text-left">
                <div>
                    <p class="text-gray-100">${ex.name}</p>
                    <p class="text-sm text-gray-500 capitalize">${ex.muscle_group} · ${ex.equipment || 'bodyweight'}</p>
                </div>
            </button>
        `).join('') || '<p class="text-center text-gray-500 py-4">No exercises found</p>';
    }
    
    function selectExerciseById(exerciseId) {
        const ex = allExercises.find(e => e.id === exerciseId);
        if (!ex) return;
        
        // Determine if this exercise should be heavy based on workout's focus
        let isHeavy = false;
        const targetWIdx = modalMode === 'swap' ? swapTarget.wIdx : addTarget.wIdx;
        const scheduleItem = cycleConfig.schedule[targetWIdx];
        if (scheduleItem && scheduleItem.heavyFocus) {
            isHeavy = isMuscleInHeavyFocus(ex.muscle_group, scheduleItem.heavyFocus);
        }
        
        const data = {
            id: ex.id,
            name: ex.name,
            muscle_group: ex.muscle_group,
            equipment: ex.equipment,
            is_compound: ex.is_compound,
            is_heavy: isHeavy,
            sets_heavy: ex.is_compound ? 4 : 3,
            sets_light: 3,
            rep_range: '8-12',
            rep_range_heavy: ex.is_compound ? '6-8' : '8-10',
            rep_range_light: '10-12',
            rest_heavy: ex.is_compound ? 180 : 60,
            rest_light: 60
        };
        
        if (modalMode === 'swap' && swapTarget) {
            cycleConfig.weeklyExercises[currentWeek][swapTarget.wIdx][swapTarget.eIdx] = data;
        } else if (modalMode === 'add' && addTarget) {
            if (!cycleConfig.weeklyExercises[currentWeek][addTarget.wIdx]) {
                cycleConfig.weeklyExercises[currentWeek][addTarget.wIdx] = [];
            }
            cycleConfig.weeklyExercises[currentWeek][addTarget.wIdx].push(data);
        }
        closeModal();
        loadExercisesForWeek();
    }
    
    function removeExercise(wIdx, eIdx) {
        cycleConfig.weeklyExercises[currentWeek][wIdx].splice(eIdx, 1);
        loadExercisesForWeek();
    }
    
    function toggleAddForm() {
        const addForm = document.getElementById('add-form');
        const addBtn = document.getElementById('add-new-btn');
        const isHidden = addForm.classList.contains('hidden');
        
        addForm.classList.toggle('hidden');
        addBtn.classList.toggle('hidden');
        
        // Reset cues container
        document.getElementById('cues-container').innerHTML = `
            <div class="flex gap-2">
                <input type="text" class="cue-input flex-1 bg-dark-600 border border-dark-500 rounded px-2 py-1.5 text-sm text-gray-100" placeholder="Cue 1">
                <button onclick="removeCueInput(this)" class="text-gray-500 hover:text-red-400">×</button>
            </div>
        `;
        
        // Scroll form into view when opening
        if (isHidden) {
            setTimeout(() => {
                addForm.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 50);
        }
    }
    
    function addCueInput() {
        const container = document.getElementById('cues-container');
        const count = container.querySelectorAll('.cue-input').length + 1;
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `
            <input type="text" class="cue-input flex-1 bg-dark-600 border border-dark-500 rounded px-2 py-1.5 text-sm text-gray-100" placeholder="Cue ${count}">
            <button onclick="removeCueInput(this)" class="text-gray-500 hover:text-red-400">×</button>
        `;
        container.appendChild(div);
    }
    
    function removeCueInput(btn) {
        const container = document.getElementById('cues-container');
        if (container.children.length > 1) {
            btn.parentElement.remove();
        }
    }
    
    async function generateCues() {
        const name = document.getElementById('new-name').value.trim();
        const muscle = document.getElementById('new-muscle').value;
        const equipment = document.getElementById('new-equipment').value;
        
        if (!name) {
            alert('Enter exercise name first');
            return;
        }
        
        const btn = document.getElementById('generate-cues-btn');
        btn.textContent = 'Generating...';
        btn.classList.add('generating');
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/exercises/generate-cues', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, muscle_group: muscle, equipment })
            });
            
            const data = await response.json();
            const cues = data.cues || [];
            
            // Populate cue inputs
            const container = document.getElementById('cues-container');
            container.innerHTML = cues.map((cue, i) => `
                <div class="flex gap-2">
                    <input type="text" class="cue-input flex-1 bg-dark-600 border border-dark-500 rounded px-2 py-1.5 text-sm text-gray-100" placeholder="Cue ${i+1}" value="${cue.replace(/"/g, '&quot;')}">
                    <button onclick="removeCueInput(this)" class="text-gray-500 hover:text-red-400">×</button>
                </div>
            `).join('');
            
            if (cues.length === 0) {
                addCueInput();
            }
            
        } catch (err) {
            console.error('Generate cues error:', err);
            alert('Failed to generate cues');
        } finally {
            btn.textContent = '✨ Generate with AI';
            btn.classList.remove('generating');
            btn.disabled = false;
        }
    }
    
    async function addNewExercise() {
        const name = document.getElementById('new-name').value.trim();
        const muscle = document.getElementById('new-muscle').value;
        const equipment = document.getElementById('new-equipment').value;
        
        // Collect cues
        const cueInputs = document.querySelectorAll('#cues-container .cue-input');
        const cues = Array.from(cueInputs).map(input => input.value.trim()).filter(c => c);
        
        if (!name || !muscle) { alert('Enter name and muscle group'); return; }
        
        try {
            const response = await fetch('/api/exercises/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, muscle_group: muscle, equipment, cues })
            });
            if (response.ok) {
                const newEx = await response.json();
                allExercises.push(newEx);
                selectExercise(newEx.id, newEx.name, newEx.muscle_group, newEx.equipment, false);
            } else throw new Error('Failed');
        } catch (err) { alert('Failed to add exercise'); }
    }
    
    async function createCycle() {
        const btn = document.getElementById('create-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';
        
        try {
            // Build workout_slots from schedule, including per-week exercises and week_pattern
            const workout_slots = cycleConfig.schedule.map((s, idx) => ({
                day_of_week: s.dayOfWeek,
                template_id: null,
                workout_name: s.workoutName,
                is_heavy_focus: s.heavyFocus,
                order_index: idx,
                week_pattern: s.week_pattern || null,  // Include week pattern for rotating splits
                // For the API, we'll send Week 1's exercises as the base
                // The backend will need to handle per-week exercise variations
                exercises: (cycleConfig.weeklyExercises[1] && cycleConfig.weeklyExercises[1][idx] || []).map((ex, exIdx) => ({
                    exercise_id: ex.id,
                    exercise_name: ex.name,
                    muscle_group: ex.muscle_group,
                    is_heavy: ex.is_heavy || false,
                    sets: ex.sets || ex.sets_light || 3,
                    sets_heavy: ex.sets_heavy || 4,
                    sets_light: ex.sets_light || 3,
                    rep_range: ex.rep_range || ex.rep_range_light || '10-12',
                    rep_range_heavy: ex.rep_range_heavy || '6-8',
                    rep_range_light: ex.rep_range_light || '10-12',
                    rest_heavy: ex.rest_heavy || 180,
                    rest_light: ex.rest_light || 60
                }))
            }));
            
            // Also include the full weekly exercise configuration
            const weekly_exercises = {};
            for (let week = 1; week <= cycleConfig.lengthWeeks; week++) {
                if (cycleConfig.weeklyExercises[week]) {
                    weekly_exercises[week] = {};
                    for (const wIdx in cycleConfig.weeklyExercises[week]) {
                        weekly_exercises[week][wIdx] = cycleConfig.weeklyExercises[week][wIdx].map(ex => ({
                            exercise_id: ex.id,
                            exercise_name: ex.name,
                            muscle_group: ex.muscle_group,
                            is_heavy: ex.is_heavy || false,
                            sets: ex.sets || ex.sets_light || 3,
                            sets_heavy: ex.sets_heavy || 4,
                            sets_light: ex.sets_light || 3,
                            rep_range: ex.rep_range || ex.rep_range_light || '10-12',
                            rep_range_heavy: ex.rep_range_heavy || '6-8',
                            rep_range_light: ex.rep_range_light || '10-12',
                            rest_heavy: ex.rest_heavy || 180,
                            rest_light: ex.rest_light || 60
                        }));
                    }
                }
            }
            
            const response = await fetch('/api/cycle/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: cycleConfig.name || `Cycle ${new Date().toLocaleDateString()}`,
                    split_type: cycleConfig.splitType,
                    length_weeks: cycleConfig.lengthWeeks,
                    start_date: cycleConfig.startDate,
                    rotation_weeks: cycleConfig.rotationWeeks || 1,  // Include rotation info
                    workout_slots: workout_slots,
                    weekly_exercises: weekly_exercises
                })
            });
            
            if (response.ok) {
                // Show success notification
                btn.textContent = 'Cycle Created! 🎉';
                btn.classList.remove('bg-accent');
                btn.classList.add('bg-success');
                
                // Brief delay so user sees success, then redirect
                setTimeout(() => {
                    window.location.href = '/plan';
                }, 800);
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Failed');
            }
        } catch (err) {
            alert('Error: ' + err.message);
            btn.textContent = 'Create Cycle';
            btn.disabled = false;
        }
    }
</script>
{% endblock %}